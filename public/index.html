<!DOCTYPE html>
<html>
<head>
  <title>POLARIS RMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #EDEDED; }
    header { background-color: #2a2d37; color: white; padding: 15px; text-align: center; }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #F5F5F5;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #87CEEB;
    }
  
    #login-section {
      max-width: 900px;
      margin: 0 0 0 20px;
      padding: 20px;
    }
  
    .login-container {
      display: flex;
      justify-content: space-between;
      gap: 80px;
      align-items: flex-start;
    }
  
    .login-form {
      flex: 1;
      min-width: 300px;
    }
  
    .disclaimer {
      flex: 0 0 80%;
      padding: 15px;
      background-color: #f9f9f9;
      border: 1px solid #87CEEB;
      border-radius: 4px;
      font-size: 13px;
      color: #333;
      line-height: 1.5;
      max-height: 430px;
      overflow-y: auto;
      margin-top: 0;
      position: relative;
      top: -60px;
    }
  
    .disclaimer h3 {
      font-size: 16px;
      color: #d32f2f;
      font-weight: bold;
      margin: 0 0 10px 0;
      text-align: center;
    }
  
    .disclaimer p {
      margin: 8px 0;
    }
  
    .disclaimer ul {
      margin: 8px 0 8px 20px;
      padding-left: 0;
    }
  
    .disclaimer li {
      margin-bottom: 5px;
    }
  
    .disclaimer strong {
      color: #003087;
    }
  
    .disclaimer .form-group {
      margin-top: 10px;
      text-align: center;
    }
  
    .disclaimer input[type="checkbox"] {
      margin-right: 5px;
    }
  
    #login-btn:disabled {
      background-color: #757575;
      cursor: not-allowed;
    }
  
    #portal, #reset-password-section { display: none; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #87CEEB; border-radius: 4px; }
    button { background-color: #003087; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
    button:hover { background-color: #00205b; }
    #login-error, #reset-error { color: #d32f2f; font-size: 14px; margin-top: 5px; }
   
    .case-table, .stats-table, .audit-table, .user-table { width: 100%; border-collapse: collapse; margin-top: 10px; background-color: #F5F5F5; }
    .case-table th, .case-table td, .stats-table th, .stats-table td, .audit-table th, .audit-table td, .user-table th, .user-table td { padding: 12px; text-align: left; border-bottom: 1px solid #87CEEB; white-space: nowrap; color: #333333; }
    .case-table th, .stats-table th, .audit-table th, .user-table th { background-color: #003087; font-weight: bold; color: #FFFFFF; }
    .case-table tr:hover, .user-table tr:hover { background-color: #E0E0E0; }
    .case-table button, .user-table button { padding: 6px 12px; margin-right: 5px; font-size: 12px; }
    
    .edit-btn { background-color: #87CEEB; }
    .edit-btn:hover { background-color: #4682B4; }
    .delete-btn { background-color: #d32f2f; }
    .delete-btn:hover { background-color: #b71c1c; }
    .view-btn { background-color: #0288d1; }
    .view-btn:hover { background-color: #4682B4; }
    .save-btn { background-color: #388e3c; }
    .save-btn:hover { background-color: #2e7d32; }
    .reset-btn { background-color: #ff9800; }
    .reset-btn:hover { background-color: #f57c00; }
   
    .scrollable { max-height: 400px; overflow-y: auto; background-color: #F5F5F5; }
   
    .stats-section { margin-top: 20px; }
    .stats-section h3 { cursor: pointer; margin: 10px 0; color: #003087; display: inline-block; }
    .stats-section .stats-table { display: none; }
    .stats-section .stats-table.active { display: table; }
    .stats-section .export-btn { margin-left: 10px; background-color: #87CEEB; font-size: 12px; padding: 6px 12px; }
    .stats-section .export-btn:hover { background-color: #4682B4; }
   
    .tabs { overflow: hidden; border-bottom: 1px solid #87CEEB; margin-bottom: 20px; }
    .tabs button { background-color: #56c8f5; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 16px; color: #333333; }
    .tabs button:hover { background-color: #4682B4; }
    .tabs button.active { background-color: #003087; color: #FFFFFF; }
   
    .tabcontent {
      display: none;
      position: relative;
      padding: 20px;
      width: 100%;
      overflow: visible;
      box-sizing: border-box;
      background-color: #F5F5F5;
    }
    .tabcontent.active {
      display: block;
    }
    div.tabcontent.active { display: block; }
    .tabcontent h2 { display: none; color: #003087; }
  
    #chart-tab.active h2 { display: block; }
    .case-details { margin-top: 20px; padding: 20px; background: #F5F5F5; border: 1px solid #87CEEB; border-radius: 4px; }
    .case-details p { margin: 10px 0; color: #333333; }
    .case-details strong { display: inline-block; width: 200px; color: #003087; }
    .charts-wrapper {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      width: 100%;
      max-width: 100%;
      padding: 0 10px;
      box-sizing: border-box;
    }
   
    .chart-container {
      flex: 1 1 calc(50% - 20px);
      min-width: 300px;
      min-height: 400px;
      max-width: 100%;
      box-sizing: border-box;
      margin: 10px;
      background-color: #F5F5F5;
    }
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
      max-width: 100%;
      max-height: 100%;
    }
    .chart-container.active canvas {
      display: block;
    }
    @media (max-width: 1024px) {
      .charts-wrapper {
        grid-template-columns: 1fr;
      }
    }
  
    #chart-tab {
      width: 100%;
      padding: 0 20px;
      box-sizing: border-box;
    }
    #user-info { float: right; margin-right: 10px; color: #333333; font-weight: bold; }
  
    .scrollable-table {
      max-height: 400px;
      overflow-x: auto;
      overflow-y: auto;
      position: relative;
      width: 100%;
      background-color: #F5F5F5;
    }
    .case-table {
      width: 100%;
      min-width: 3000px;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: auto;
      background-color: #FFFFFF;
    }
    .case-table thead th {
      position: sticky;
      top: 0;
      background-color: #003087;
      color: #FFFFFF;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .case-table th, .case-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #87CEEB;
      white-space: nowrap;
      color: #333333;
    }
  
    .case-table td[style*="position: sticky; left: 0"] {
      background-color: #F5F5F5;
      position: sticky;
      left: 0;
      z-index: 1;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
    }
  
    .case-table th.frozen {
      position: sticky;
      right: 0;
      background-color: #003087;
      color: #FFFFFF;
      z-index: 3;
      min-width: 200px;
      box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .case-table td:last-child {
      position: sticky;
      right: 0;
      background-color: #F5F5F5;
      z-index: 1;
      min-width: 200px;
      box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .within-deadline {
      color: #2e7d32;
      font-weight: bold;
    }
    .over-deadline {
      color: #d32f2f;
      font-weight: bold;
    }
    .error-report-btn {
      background-color: #d32f2f;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      display: block;
      margin: 20px 20px 0 auto;
      z-index: 1001;
    }
    .error-report-btn:hover {
      background-color: #b71c1c;
    }
  
    .error-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #F5F5F5;
      padding: 20px;
      border: 1px solid #87CEEB;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 300px;
    }
    .error-modal textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
      padding: 5px;
      box-sizing: border-box;
      border: 1px solid #87CEEB;
      border-radius: 4px;
      background-color: #FFFFFF;
    }
    .error-modal button {
      margin-right: 10px;
      background-color: #003087;
      color: #FFFFFF;
    }
  
    .scrollable-table {
      max-height: 400px;
      overflow-x: auto;
      overflow-y: auto;
      position: relative;
      width: 100%;
      background-color: #F5F5F5;
    }
    .officer-table {
      width: 100%;
      min-width: 1200px;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: auto;
      background-color: #F5F5F5;
    }
    .officer-table thead th {
      position: sticky;
      top: 0;
      background-color: #003087;
      color: #FFFFFF;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .officer-table th.frozen {
      position: sticky;
      right: 0;
      background-color: #003087;
      color: #FFFFFF;
      z-index: 3;
      min-width: 150px;
      box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .officer-table td:nth-child(8) {
      position: sticky;
      right: 0;
      background-color: #F5F5F5;
      z-index: 1;
      min-width: 150px;
      box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      gap: 5px;
    }
  
    /* Specific to officer-list */
    #disclosure-officer-list {
      display: block;
      width: 100%;
      overflow-y: visible;
      max-height: none;
      padding: 10px;
      box-sizing: border-box;
      background-color: #F5F5F5;
    }
    #disclosure-officer-list h3 {
      margin: 0 0 15px 0;
      color: #003087;
    }
  
    .officer-entry {
      display: block;
      border: 1px solid #87CEEB;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      width: 100%;
      background-color: #F5F5F5;
    }
    .officer-entry .form-group {
      display: inline-block;
      width: 30%;
      margin-right: 3%;
      vertical-align: top;
    }
    .officer-entry .form-group:last-child {
      margin-right: 0;
    }
    .officer-entry button {
      vertical-align: top;
      background-color: #003087;
      color: #FFFFFF;
    }
  
    /* Specific styles for the permissions table */
    #permissions-table {
      width: 100%;
      min-width: 800px;
      table-layout: auto;
      border-collapse: collapse;
      background-color: #F5F5F5;
    }
  
    #permissions-table th,
    #permissions-table td {
      padding: 8px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #333333;
      border-bottom: 1px solid #87CEEB;
      position: relative; /* For pseudo-element positioning */
    }
  
    #permissions-table th {
      background-color: #003087;
      color: #FFFFFF;
      font-weight: bold;
      border-bottom: 1px solid #87CEEB;
    }
  
    /* Specific column widths */
    #permissions-table th:nth-child(1), /* ID */
    #permissions-table td:nth-child(1) {
      width: 60px;
    }
  
    #permissions-table th:nth-child(2), /* Username */
    #permissions-table td:nth-child(2) {
      width: 120px;
    }
  
    #permissions-table th:nth-child(3), /* Case ID */
    #permissions-table td:nth-child(3) {
      width: 100px;
    }
  
    #permissions-table th:nth-child(4), /* Can View */
    #permissions-table td:nth-child(4) {
      width: 80px;
    }
  
    #permissions-table th:nth-child(5), /* Can Edit */
    #permissions-table td:nth-child(5) {
      width: 80px;
    }
  
    #permissions-table th:nth-child(6), /* Assigned By */
    #permissions-table td:nth-child(6) {
      width: 120px;
    }
  
    #permissions-table th:nth-child(7), /* Assigned Date */
    #permissions-table td:nth-child(7) {
      width: 100px;
    }
  
    #permissions-table th:nth-child(8), /* Actions */
    #permissions-table td:nth-child(8) {
      width: 100px;
      position: sticky;
      right: 0;
      box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      text-align: center;
      border-bottom: none; /* Remove default border to use pseudo-element */
    }
  
    #permissions-table td:nth-child(8) { /* Cells only */
      background-color: #F5F5F5;
      color: #333333;
      z-index: 1;
    }
  
    /* Prevent hover background change on Actions column */
    #permissions-table tr:hover td:nth-child(8) {
      background-color: #F5F5F5; /* Keep light grey on hover */
    }
  
    #permissions-table th:nth-child(8) { /* Header only */
      z-index: 3;
    }
  
    /* Add pseudo-element for light blue border in Actions column */
    #permissions-table td:nth-child(8)::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: #87CEEB;
      z-index: 2;
    }
  
    /* Remove border from the last cell of the last row only */
    #permissions-table tr:last-child td:last-child::after {
      display: none;
    }
  
    /* Ensure the table remains scrollable */
    .scrollable-table {
      max-height: 400px;
      overflow-x: auto;
      overflow-y: auto;
      position: relative;
      width: 100%;
      background-color: #F5F5F5;
    }
  </style>
</head>
<div id="add-officer-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; width: 80%; max-height: 80%; overflow-y: auto;">
  <h2>Add New Officer</h2>
  <form id="add-officer-form">
    <div class="form-group">
      <label for="add-officer-name">Officer Name *</label>
      <input id="add-officer-name" name="officer" required>
    </div>
    <div class="form-group">
      <label for="add-officer-staffNo">Staff No. *</label>
      <input id="add-officer-staffNo" name="staffNo" placeholder="Enter staff number" required>
    </div>
    <div class="form-group">
      <label for="add-officer-dateOccurrence">Date of Occurrence *</label>
      <input id="add-officer-dateOccurrence" name="dateOccurrence" type="date" required>
    </div>
    <div class="form-group">
      <label for="add-officer-type">Type</label>
      <select id="add-officer-type" name="type">
        <option value="">Select type</option>
        <option value="Misconduct">Misconduct</option>
        <option value="Complaint">Complaint</option>
        <option value="Criminal Conduct">Criminal Conduct</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-status">Status</label>
      <select id="add-officer-status" name="status">
        <option value="">Select status</option>
        <option value="Open">Open</option>
        <option value="Closed">Closed</option>
        <option value="Pending">Pending</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-summary">Summary of Allegation</label>
      <textarea id="add-officer-summary" name="summary" placeholder="Enter summary"></textarea>
    </div>
    <div class="form-group">
      <label for="add-officer-breaches">Breaches of Standards (Ctrl+Click)</label>
      <select id="add-officer-breaches" name="breachOfStandards" multiple size="5">
        <option value="Honesty and Integrity">Honesty and Integrity</option>
        <option value="Authority, Respect and Courtesy">Authority, Respect and Courtesy</option>
        <option value="Equality and Diversity">Equality and Diversity</option>
        <option value="Use of Force">Use of Force</option>
        <option value="Orders and Instructions">Orders and Instructions</option>
        <option value="Duties and Responsibilities">Duties and Responsibilities</option>
        <option value="Confidentiality">Confidentiality</option>
        <option value="Fitness for Duty">Fitness for Duty</option>
        <option value="Discreditable Conduct">Discreditable Conduct</option>
        <option value="Challenging and Reporting Improper Conduct">Challenging and Reporting Improper Conduct</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-investigator">Appointed Investigator</label>
      <input id="add-officer-investigator" name="investigator" placeholder="Enter investigator">
    </div>
    <div class="form-group">
      <label for="add-officer-severity">Severity Assessment</label>
      <select id="add-officer-severity" name="severity">
        <option value="">Select severity</option>
        <option value="NFA">NFA</option>
        <option value="Withdrawn">Withdrawn</option>
        <option value="Performance">Performance</option>
        <option value="Management Action">Management Action</option>
        <option value="Reflective Practice">Reflective Practice</option>
        <option value="Misconduct">Misconduct</option>
        <option value="Gross Misconduct">Gross Misconduct</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-section17Date">Section 17 Delivered</label>
      <input id="add-officer-section17Date" name="section17Date" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-policeFriend">Name of Police Friend</label>
      <input id="add-officer-policeFriend" name="policeFriend" placeholder="Enter police friend">
    </div>
    <div class="form-group">
      <label for="add-officer-section18Date">Section 18 Reply Date</label>
      <input id="add-officer-section18Date" name="section18Date" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-interviewDate">Date of Interview</label>
      <input id="add-officer-interviewDate" name="interviewDate" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-ioReportDate">Date IO Report Completed</label>
      <input id="add-officer-ioReportDate" name="ioReportDate" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-raAssessment">Assessment by RA</label>
      <select id="add-officer-raAssessment" name="raAssessment">
        <option value="">Select RA assessment</option>
        <option value="NFA">NFA</option>
        <option value="Withdrawn">Withdrawn</option>
        <option value="Performance">Performance</option>
        <option value="Management Action">Management Action</option>
        <option value="Reflective Practice">Reflective Practice</option>
        <option value="Misconduct">Misconduct</option>
        <option value="Gross Misconduct">Gross Misconduct</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-referral">Officer Advised of Referral</label>
      <select id="add-officer-referral" name="officerAdvisedOfReferral">
        <option value="">Select option</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-section24Reply">Section 24 Reply to RA</label>
      <select id="add-officer-section24Reply" name="section24ReplyToRA">
        <option value="">Select option</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
        </div>
    <div class="form-group">
      <label for="add-officer-misconductMeetingDate">Misconduct Meeting Date</label>
      <input id="add-officer-misconductMeetingDate" name="misconductMeetingDate" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-misconductOutcome">Misconduct Outcome</label>
      <select id="add-officer-misconductOutcome" name="misconductOutcome">
        <option value="">Select outcome</option>
        <option value="NFA">NFA</option>
        <option value="Withdrawn">Withdrawn</option>
        <option value="Management Action">Management Action</option>
        <option value="Reflective Practice">Reflective Practice</option>
        <option value="Management Advice">Management Advice</option>
        <option value="Written Warning">Written Warning</option>
        <option value="Final Written Warning">Final Written Warning</option>
        <option value="Retired">Retired</option>
        <option value="Resigned">Resigned</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-grossMisconductHearingDate">Gross Misconduct Hearing Date</label>
      <input id="add-officer-grossMisconductHearingDate" name="grossMisconductHearingDate" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-hearingOutcome">Hearing Outcome</label>
      <select id="add-officer-hearingOutcome" name="hearingOutcome">
        <option value="">Select outcome</option>
        <option value="NFA">NFA</option>
        <option value="Withdrawn">Withdrawn</option>
        <option value="Management Action">Management Action</option>
        <option value="Reflective Practice">Reflective Practice</option>
        <option value="Management Advice">Management Advice</option>
        <option value="Written Warning">Written Warning</option>
        <option value="Final Written Warning">Final Written Warning</option>
        <option value="Reduction in Rank">Reduction in Rank</option>
        <option value="Dismissal with Notice">Dismissal with Notice</option>
        <option value="Dismissal Without Notice">Dismissal Without Notice</option>
        <option value="Retired">Retired</option>
        <option value="Resigned">Resigned</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-appealMade">Appeal Made by Officer</label>
      <select id="add-officer-appealMade" name="appealMade">
        <option value="">Select option</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-appealLetterDate">Appeal Letter Received</label>
      <input id="add-officer-appealLetterDate" name="appealLetterDate" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-appealHearingDate">Appeal Hearing Date Set</label>
      <input id="add-officer-appealHearingDate" name="appealHearingDate" type="date">
    </div>
    <div class="form-group">
      <label for="add-officer-appealOutcome">Appeal Outcome</label>
      <select id="add-officer-appealOutcome" name="appealOutcome">
        <option value="">Select outcome</option>
        <option value="Appeal Withheld">Appeal Withheld</option>
        <option value="Appeal Overturned">Appeal Overturned</option>
      </select>
    </div>
    <div class="form-group">
      <label for="add-officer-comments">Comments</label>
      <textarea id="add-officer-comments" name="comments" placeholder="Enter comments"></textarea>
    </div>
    <button type="button" onclick="submitAddOfficer()">Add Officer</button>
    <button type="button" onclick="closeAddOfficerModal()" style="background-color: #757575;">Cancel</button>
  </form>
</div>
<div id="edit-officer-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; width: 80%; max-height: 80%; overflow-y: auto;">
  <h2>Edit Officer Profile</h2>
  <form id="edit-officer-form">
    <div class="form-group">
      <label for="edit-officer-staffNo">Staff No.</label>
      <input id="edit-officer-staffNo" name="staffNo" readonly style="background-color: #e0e0e0;">
    </div>
    <div class="form-group">
      <label for="edit-officer-name">Name</label>
      <input id="edit-officer-name" name="name" readonly style="background-color: #e0e0e0;">
    </div>
    <div class="form-group">
      <label for="edit-officer-joiningDate">Joining Date</label>
      <input id="edit-officer-joiningDate" name="joiningDate" type="date">
    </div>
    <div class="form-group">
      <label for="edit-officer-rank">Rank</label>
      <input id="edit-officer-rank" name="rank" placeholder="Enter rank">
    </div>
    <div class="form-group">
      <label for="edit-officer-dateOfBirth">Date of Birth</label>
      <input id="edit-officer-dateOfBirth" name="dateOfBirth" type="date">
    </div>
    <button type="button" onclick="saveOfficer()">Save</button>
    <button type="button" onclick="closeEditOfficerModal()" style="background-color: #757575;">Cancel</button>
  </form>
</div>
<div id="modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>
<body>
  <header>
    <h1>POLARIS RMS</h1>
  </header>
  <div class="container">
    <div id="login-section">
      <h2>Login</h2>
      <div class="login-container">
        <!-- Left: Login Form -->
        <div class="login-form">
          <form id="login-form" onsubmit="login(); return false;">
            <div class="form-group">
              <label for="username">Username</label>
              <input id="username" type="text" placeholder="Enter username" autocomplete="username">
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input id="password" type="password" placeholder="Enter password" autocomplete="current-password" fdprocessedid="uiskok">
              <input type="hidden" id="client-ip" value=" simulated-ip "> <!-- Placeholder -->
            </div>
            <button type="submit" id="login-btn" disabled>Log In</button>
          </form>
          <p><a href="#" onclick="showResetRequest()">Forgot Password?</a></p>
          <div id="reset-request" style="display: none;">
            <form id="reset-request-form" onsubmit="requestPasswordReset(); return false;">
              <div class="form-group">
                <label for="reset-username">Username</label>
                <input id="reset-username" placeholder="Enter username">
              </div>
              <div class="form-group">
                <label for="reset-email">Email</label>
                <input id="reset-email" placeholder="Enter email">
              </div>
              <button type="submit">Request Reset</button>
            </form>
          </div>
          <p id="login-error"></p>
        </div>
        <!-- Right: Disclaimer -->
        <div class="disclaimer">
          <h3>Disclaimer Warning: Access to Police Systems</h3>
          <p>You are accessing a restricted police system that contains sensitive and confidential information. Access is strictly limited to official police duties and must comply with the Data Protection Act 2004, the Gibraltar General Data Protection Regulation (Gib GDPR), and relevant police policies and codes of conduct.</p>
          <p>Unauthorised access, misuse, or personal use of this system is strictly prohibited. Any access or processing of data must be for a lawful policing purpose and in line with the principles of necessity and proportionality.</p>
          <p>Any misuse, including unauthorised searches, accessing records without a policing purpose, or sharing information improperly, may result in:</p>
          <ul>
            <li>Criminal prosecution under the Data Protection Act 2004, Part 15 of the Crimes Act 2001, or other relevant legislation.</li>
            <li>Misconduct proceedings, including potential dismissal from the police service.</li>
            <li>Civil liability, where affected individuals may take legal action.</li>
          </ul>
          <p>All access to this system is monitored and audited. Any suspicious activity will be investigated, and breaches will be reported for appropriate action.</p>
          <p><strong>By proceeding, you confirm that you understand and accept your legal and professional obligations when accessing police systems.</strong></p>
          <div class="form-group">
            <label for="disclaimer-agree">
              <input type="checkbox" id="disclaimer-agree" onchange="toggleLoginButton()"> I have read and agree to the disclaimer
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <div id="reset-password-section">
      <h2>Reset Password</h2>
      <p>Please set a new password.</p>
      <form id="reset-password-form" onsubmit="resetPassword(); return false;">
        <div class="form-group">
          <label for="new-password">New Password</label>
          <input id="new-password" type="password" placeholder="Enter new password" autocomplete="new-password">
        </div>
        <button type="submit">Set Password</button>
      </form>
      <p id="reset-error"></p>
    </div>

    <div id="portal">
      <span id="user-info"></span>
      <button onclick="logout()" style="float: right;">Logout</button>
      <div class="tabs">
        <button class="tablink" onclick="openTab(event, 'cases')" id="defaultOpen">PSD Cases</button>
        <button class="tablink" id="add-case-tab" style="display: none;" onclick="openTab(event, 'add-case')">Add New Case</button>
        <button class="tablink" id="edit-case-tab" style="display: none;" onclick="openTab(event, 'edit-case')">Edit Case</button>
        <button class="tablink" onclick="openTab(event, 'staff-search')">Staff Search</button>
        <button class="tablink" id="stats-tab" style="display: none;" onclick="openTab(event, 'stats')">Statistics</button>
        <button class="tablink" id="chart-tab-btn" style="display: none;" onclick="openTab(event, 'chart-tab')">Charts</button>
        <button class="tablink" id="admin-tab" style="display: none;" onclick="openTab(event, 'admin-area')">Admin Area</button>
        <button class="tablink" id="officer-profiles-tab" onclick="openTab(event, 'officer-profiles')">Officer Profiles</button>
        <button class="tablink" id="disclosure-tab" onclick="openTab(event, 'disclosure-area')" style="display: none;">Disc Report</button>     
      </div>

      <div id="cases" class="tabcontent">
        <h2>Cases</h2>
        <div class="form-group">
          <label for="search">Search Cases</label>
          <input id="search" placeholder="Search by ID, type, status, or officer" onkeyup="searchCases()">
        </div>
        <div class="scrollable-table">
          <table class="case-table" id="case-list">
            <thead>
              <tr>
                <th style="position: sticky; left: 0; background-color: #003087; z-index: 3;">Case ID</th>
                <th>Date of Occurrence</th>
                <th>Type</th>
                <th style="width: 80px;"> <!-- Narrower column width -->
                  <div style="display: flex; flex-direction: column; align-items: center;">
                    Status
                    <select id="status-filter" onchange="filterCasesByStatus()" style="font-size: 12px; width: 70px;">
                    <option value="">All</option>
                    <option value="Open">Open</option>
                    <option value="Closed">Closed</option>
                    <option value="Pending Severity Assessment">Pending Severity Assessment</option>
                    <option value="Pending IO Appointment">Pending IO Appointment</option>
                    <option value="Pending Referral to Independent Force">Pending Referral to Independent Force</option>
                    <option value="Referred to Independent Force">Referred to Independent Force</option>                    
                  </select>
                </th>
                <th>Staff No.</th>
                <th>Officer</th>
                <th>Summary</th>
                <th>Breaches of Standards</th>
                <th>Investigator</th>
                <th>Severity</th>
                <th>Section 17</th>
                <th>Police Friend</th>
                <th>Section 18</th>
                <th>Interview</th>
                <th>IO Report</th>
                <th>RA Assessment</th>
                <th>Notice of Referral</th>
                <th>Section 24 Reply</th>
                <th>Misconduct Mtg</th>
                <th>Misconduct Outcome</th>
                <th>GM Hearing</th>
                <th>Hearing Outcome</th>
                <th>Appeal Made</th>
                <th>Appeal Letter</th>
                <th>Appeal Hearing</th>
                <th>Appeal Outcome</th>
                <th>Comments</th>
                <th>Files</th>
                <th class="frozen">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="case-details" class="case-details" style="display: none;"></div>
      </div>

      <div id="stats" class="tabcontent">
        <div class="stats-section">
          <h2>Case Statistics</h2>
          <button onclick="exportAllStats()">Export All Stats</button>
          <div>
            <h3 onclick="toggleStats('casesPerYear')">Cases per Year</h3>
            <button class="export-btn" onclick="exportCasesPerYear()">Export</button>
            <table class="stats-table" id="casesPerYear">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('severity')">Severity Assessment</h3>
            <button class="export-btn" onclick="exportSeverity()">Export</button>
            <table class="stats-table" id="severity">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Severity</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('raAssessment')">Assessment by RA</h3>
            <button class="export-btn" onclick="exportRaAssessment()">Export</button>
            <table class="stats-table" id="raAssessment">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>RA Assessment</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('misconductOutcome')">Misconduct Outcome</h3>
            <button class="export-btn" onclick="exportMisconductOutcome()">Export</button>
            <table class="stats-table" id="misconductOutcome">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Misconduct Outcome</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('hearingOutcome')">Hearing Outcome</h3>
            <button class="export-btn" onclick="exportHearingOutcome()">Export</button>
            <table class="stats-table" id="hearingOutcome">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Hearing Outcome</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('appealsPerYear')">Appeals per Year</h3>
            <button class="export-btn" onclick="exportAppealsPerYear()">Export</button>
            <table class="stats-table" id="appealsPerYear">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('appealOutcome')">Appeal Outcome</h3>
            <button class="export-btn" onclick="exportAppealOutcome()">Export</button>
            <table class="stats-table" id="appealOutcome">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Appeal Outcome</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('caseStatus')">Case Status</h3>
            <button class="export-btn" onclick="exportCaseStatus()">Export</button>
            <table class="stats-table" id="caseStatus">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Status</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('breachesOfStandards')">Breaches of Standards</h3>
            <button class="export-btn" onclick="exportBreachesOfStandards()">Export</button>
            <table class="stats-table" id="breachesOfStandards">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Breach of Standards</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('officerAgeAtIncident')">Officer Age at Incident</h3>
            <button class="export-btn" onclick="exportOfficerAgeAtIncident()">Export</button>
            <table class="stats-table" id="officerAgeAtIncident">
              <thead>
                <tr>
                  <th>Age (Years)</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 onclick="toggleStats('serviceLengthAtIncident')">Length of Service at Incident</h3>
            <button class="export-btn" onclick="exportServiceLengthAtIncident()">Export</button>
            <table class="stats-table" id="serviceLengthAtIncident">
              <thead>
                <tr>
                  <th>Service (Years)</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="chart-tab" class="tabcontent">
        <h2>Statistical Dashboard</h2>
        <div class="charts-wrapper">
          <div class="chart-container">
            <canvas id="casesPerYearBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="severityBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="raAssessmentBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="misconductOutcomeBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="hearingOutcomeBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="appealsPerYearBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="appealOutcomeBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="caseStatusBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="breachesOfStandardsBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="officerAgeBarChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="serviceLengthBarChart"></canvas>
          </div>
        </div>
      </div>

      <div id="add-case" class="tabcontent">
        <h2>Add New Case</h2>
        <form id="add-case-form" enctype="multipart/form-data">
          <div class="form-group">
            <label for="add-id">Case ID *</label>
            <div style="display: flex; align-items: center;">
              <span style="padding: 10px; background-color: #e0e0e0; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px;">PSD/</span>
              <input id="add-id" name="id" placeholder="Enter case ID (e.g., 001)" required style="border-radius: 0 4px 4px 0; margin-top: 0;">
            </div>
          </div>
          <div class="form-group">
            <label for="add-dateOccurrence">Date of Occurrence</label>
            <input id="add-dateOccurrence" name="dateOccurrence" type="date">
          </div>
          <div class="form-group">
            <label for="add-type">Type</label>
            <select id="add-type" name="type">
              <option value="">Select type</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Complaint">Complaint</option>
              <option value="Criminal Conduct">Criminal Conduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-status">Status *</label>
            <select id="add-status" name="status" required>
              <option value="">Select status</option>
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
              <option value="Pending Severity Assessment">Pending Severity Assessment</option>
              <option value="Pending IO Appointment">Pending IO Appointment</option>
              <option value="Pending Referral to Independent Force">Pending Referral to Independent Force</option>
              <option value="Referred to Independent Force">Referred to Independent Force</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-staffNo">Staff No. *</label>
            <input id="add-staffNo" name="staffNo" placeholder="Enter staff number" required>
          </div>
          <div class="form-group">
            <label for="add-officer">Officer *</label>
            <input id="add-officer" name="officer" placeholder="Enter officer" required>
          </div>
          <div class="form-group">
            <label for="add-summary">Summary of Allegation</label>
            <textarea id="add-summary" name="summary" placeholder="Enter summary"></textarea>
          </div>
          <div class="form-group">
            <label for="add-breachOfStandards">Breaches of Standards (Ctrl+Click)</label>
            <select id="add-breachOfStandards" name="breachOfStandards" multiple size="5">
              <option value="Honesty and Integrity">Honesty and Integrity</option>
              <option value="Authority, Respect and Courtesy">Authority, Respect and Courtesy</option>
              <option value="Equality and Diversity">Equality and Diversity</option>
              <option value="Use of Force">Use of Force</option>
              <option value="Orders and Instructions">Orders and Instructions</option>
              <option value="Duties and Responsibilities">Duties and Responsibilities</option>
              <option value="Confidentiality">Confidentiality</option>
              <option value="Fitness for Duty">Fitness for Duty</option>
              <option value="Discreditable Conduct">Discreditable Conduct</option>
              <option value="Challenging and Reporting Improper Conduct">Challenging and Reporting Improper Conduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-investigator">Appointed Investigator</label>
            <input id="add-investigator" name="investigator" placeholder="Enter investigator">
          </div>
          <div class="form-group">
            <label for="add-severity">Severity Assessment</label>
            <select id="add-severity" name="severity">
              <option value="">Select severity</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Performance">Performance</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Gross Misconduct">Gross Misconduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-section17Date">Section 17 Delivered</label>
            <input id="add-section17Date" name="section17Date" type="date">
          </div>
          <div class="form-group">
            <label for="add-policeFriend">Name of Police Friend</label>
            <input id="add-policeFriend" name="policeFriend" placeholder="Enter police friend">
          </div>
          <div class="form-group">
            <label for="add-section18Date">Section 18 Reply Date</label>
            <input id="add-section18Date" name="section18Date" type="date">
          </div>
          <div class="form-group">
            <label for="add-interviewDate">Date of Interview</label>
            <input id="add-interviewDate" name="interviewDate" type="date">
          </div>
          <div class="form-group">
            <label for="add-ioReportDate">Date IO Report Completed</label>
            <input id="add-ioReportDate" name="ioReportDate" type="date">
          </div>
          <div class="form-group">
            <label for="add-raAssessment">Assessment by RA</label>
            <select id="add-raAssessment" name="raAssessment">
              <option value="">Select RA assessment</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Performance">Performance</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Gross Misconduct">Gross Misconduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-officerAdvisedOfReferral">Notice of Referral</label>
            <input id="add-officerAdvisedOfReferral" name="officerAdvisedOfReferral" type="date">
          </div>
          <div class="form-group">
            <label for="add-section24ReplyToRA">Section 24 Reply</label>
            <input id="add-section24ReplyToRA" name="section24ReplyToRA" type="date">
          </div>
          <div class="form-group">
            <label for="add-misconductMeetingDate">Misconduct Meeting Date</label>
            <input id="add-misconductMeetingDate" name="misconductMeetingDate" type="date">
          </div>
          <div class="form-group">
            <label for="add-misconductOutcome">Meeting Outcome</label>
            <select id="add-misconductOutcome" name="MeetingOutcome">
              <option value="">Select outcome</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Management Advice">Management Advice</option>
              <option value="Written Warning">Written Warning</option>
              <option value="Final Written Warning">Final Written Warning</option>
              <option value="Retired">Retired</option>
              <option value="Resigned">Resigned</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-grossMisconductHearingDate">Gross Misconduct Hearing Date</label>
            <input id="add-grossMisconductHearingDate" name="grossMisconductHearingDate" type="date">
          </div>
          <div class="form-group">
            <label for="add-hearingOutcome">Hearing Outcome</label>
            <select id="add-hearingOutcome" name="hearingOutcome">
              <option value="">Select outcome</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Management Advice">Management Advice</option>
              <option value="Written Warning">Written Warning</option>
              <option value="Final Written Warning">Final Written Warning</option>
              <option value="Reduction in Rank">Reduction in Rank</option>
              <option value="Dismissal with Notice">Dismissal with Notice</option>
              <option value="Dismissal Without Notice">Dismissal Without Notice</option>
              <option value="Retired">Retired</option>
              <option value="Resigned">Resigned</option>
            </select>
           </div>
          <div class="form-group">
            <label for="add-appealMade">Appeal Made by Officer</label>
            <select id="add-appealMade" name="appealMade">
              <option value="">Select option</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-appealLetterDate">Appeal Letter Received</label>
            <input id="add-appealLetterDate" name="appealLetterDate" type="date">
          </div>
          <div class="form-group">
            <label for="add-appealHearingDate">Appeal Hearing Date Set</label>
            <input id="add-appealHearingDate" name="appealHearingDate" type="date">
          </div>
          <div class="form-group">
            <label for="add-appealOutcome">Appeal Outcome</label>
            <select id="add-appealOutcome" name="appealOutcome">
              <option value="">Select outcome</option>
              <option value="Appeal Withheld">Appeal Withheld</option>
              <option value="Appeal Overturned">Appeal Overturned</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add-comments">Comments</label>
            <textarea id="add-comments" name="comments" placeholder="Enter comments"></textarea>
          </div>
          <div class="form-group">
            <label for="add-files">Investigation Files</label>
            <input id="add-files" name="files" type="file" multiple>
          </div>
          <button type="button" onclick="addCase()">Add Case</button>
          <button type="button" onclick="clearAddForm()" style="background-color: #757575;">Clear Form</button>
          <button type="button" onclick="openTab(event, 'cases')">Back</button>
        </form>
      </div>

      <div id="edit-case" class="tabcontent">
        <h2>Edit Case</h2>
        <form id="edit-case-form" enctype="multipart/form-data">
          <div class="form-group">
            <label for="edit-id">Case ID</label>
            <input id="edit-id" name="id" readonly style="background-color: #e0e0e0;">
          </div>
        <div class="form-group">
          <label for="edit-officerId">Officer Record ID</label>
          <input id="edit-officerId" name="officerId" type="hidden">
        </div>
          <div class="form-group">
            <label for="edit-dateOccurrence">Date of Occurrence</label>
            <input id="edit-dateOccurrence" name="dateOccurrence" type="date">
          </div>
          <div class="form-group">
            <label for="edit-type">Type</label>
            <select id="edit-type" name="type">
              <option value="">Select type</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Complaint">Complaint</option>
              <option value="Criminal Conduct">Criminal Conduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-status">Status</label>
            <select id="edit-status" name="status">
              <option value="">Select status</option>
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
              <option value="Pending Severity Assessment">Pending Severity Assessment</option>
              <option value="Pending IO Appointment">Pending IO Appointment</option>
              <option value="Pending Referral to Independent Force">Pending Referral to Independent Force</option>
              <option value="Referred to Independent Force">Referred to Independent Force</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-officer-select">Select Officer *</label>
            <select id="edit-officer-select" name="officerId"></select>
          </div>
          <div class="form-group">
            <label for="edit-staffNo">Staff No.</label>
            <input id="edit-staffNo" name="staffNo" placeholder="Enter staff number">
          </div>
          <div class="form-group">
            <label for="edit-officer">Officer</label>
            <input id="edit-officer" name="officer" placeholder="Enter officer" readonly>
          </div>
          <div class="form-group">
            <label for="edit-summary">Summary of Allegation</label>
            <textarea id="edit-summary" name="summary" placeholder="Enter summary"></textarea>
          </div>
          <div class="form-group">
            <label for="edit-breachOfStandards">Breaches of Standards (Ctrl+Click)</label>
            <select id="edit-breachOfStandards" name="breachOfStandards" multiple size="5">
              <option value="Honesty and Integrity">Honesty and Integrity</option>
              <option value="Authority, Respect and Courtesy">Authority, Respect and Courtesy</option>
              <option value="Equality and Diversity">Equality and Diversity</option>
              <option value="Use of Force">Use of Force</option>
              <option value="Orders and Instructions">Orders and Instructions</option>
              <option value="Duties and Responsibilities">Duties and Responsibilities</option>
              <option value="Confidentiality">Confidentiality</option>
              <option value="Fitness for Duty">Fitness for Duty</option>
              <option value="Discreditable Conduct">Discreditable Conduct</option>
              <option value="Challenging and Reporting Improper Conduct">Challenging and Reporting Improper Conduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-investigator">Appointed Investigator</label>
            <input id="edit-investigator" name="investigator" placeholder="Enter investigator">
          </div>
          <div class="form-group">
            <label for="edit-severity">Severity Assessment</label>
            <select id="edit-severity" name="severity">
              <option value="">Select severity</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Performance">Performance</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Gross Misconduct">Gross Misconduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-section17Date">Section 17 Delivered</label>
            <input id="edit-section17Date" name="section17Date" type="date">
          </div>
          <div class="form-group">
            <label for="edit-policeFriend">Name of Police Friend</label>
            <input id="edit-policeFriend" name="policeFriend" placeholder="Enter police friend">
          </div>
          <div class="form-group">
            <label for="edit-section18Date">Section 18 Reply Date</label>
            <input id="edit-section18Date" name="section18Date" type="date">
          </div>
          <div class="form-group">
            <label for="edit-interviewDate">Date of Interview</label>
            <input id="edit-interviewDate" name="interviewDate" type="date">
          </div>
          <div class="form-group">
            <label for="edit-ioReportDate">Date IO Report Completed</label>
            <input id="edit-ioReportDate" name="ioReportDate" type="date">
          </div>
          <div class="form-group">
            <label for="edit-raAssessment">Assessment by RA</label>
            <select id="edit-raAssessment" name="raAssessment">
              <option value="">Select RA assessment</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Performance">Performance</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Misconduct">Misconduct</option>
              <option value="Gross Misconduct">Gross Misconduct</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-officerAdvisedOfReferral">Notice of Referral</label>
            <input id="edit-officerAdvisedOfReferral" name="officerAdvisedOfReferral" type="date">
          </div>
          <div class="form-group">
            <label for="edit-section24ReplyToRA">Section 24 Reply</label>
            <input id="edit-section24ReplyToRA" name="section24ReplyToRA" type="date">
          </div>
          <div class="form-group">
            <label for="edit-misconductMeetingDate">Misconduct Meeting Date</label>
            <input id="edit-misconductMeetingDate" name="misconductMeetingDate" type="date">
          </div>
          <div class="form-group">
            <label for="edit-misconductOutcome">Misconduct Outcome</label>
            <select id="edit-misconductOutcome" name="Misconduct Outcome">
              <option value="">Select outcome</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Management Advice">Management Advice</option>
              <option value="Written Warning">Written Warning</option>
              <option value="Final Written Warning">Final Written Warning</option>
              <option value="Retired">Retired</option>
              <option value="Resigned">Resigned</option>
            </select>
            <button type="button" onclick="resetEditMisconductOutcome()">Clear</button>
          </div>
          <div class="form-group">
            <label for="edit-grossMisconductHearingDate">Gross Misconduct Hearing Date</label>
            <input id="edit-grossMisconductHearingDate" name="grossMisconductHearingDate" type="date">
          </div>
          <div class="form-group">
            <label for="edit-hearingOutcome">Hearing Outcome</label>
            <select id="edit-hearingOutcome" name="hearingOutcome">
              <option value="">Select outcome</option>
              <option value="NFA">NFA</option>
              <option value="Withdrawn">Withdrawn</option>
              <option value="Management Action">Management Action</option>
              <option value="Reflective Practice">Reflective Practice</option>
              <option value="Management Advice">Management Advice</option>
              <option value="Written Warning">Written Warning</option>
              <option value="Final Written Warning">Final Written Warning</option>
              <option value="Reduction in Rank">Reduction in Rank</option>
              <option value="Dismissal with Notice">Dismissal with Notice</option>
              <option value="Dismissal Without Notice">Dismissal Without Notice</option>
              <option value="Retired">Retired</option>
              <option value="Resigned">Resigned</option>
            </select>
            <button type="button" onclick="resetEditHearingOutcome()">Clear</button>
          </div>
          <div class="form-group">
            <label for="edit-appealMade">Appeal Made by Officer</label>
            <select id="edit-appealMade" name="appealMade">
              <option value="">Select option</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-appealLetterDate">Appeal Letter Received</label>
            <input id="edit-appealLetterDate" name="appealLetterDate" type="date">
          </div>
          <div class="form-group">
            <label for="edit-appealHearingDate">Appeal Hearing Date Set</label>
            <input id="edit-appealHearingDate" name="appealHearingDate" type="date">
          </div>
          <div class="form-group">
            <label for="edit-appealOutcome">Appeal Outcome</label>
            <select id="edit-appealOutcome" name="appealOutcome">
              <option value="">Select outcome</option>
              <option value="Appeal Withheld">Appeal Withheld</option>
              <option value="Appeal Overturned">Appeal Overturned</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-comments">Comments</label>
            <textarea id="edit-comments" name="comments" placeholder="Enter comments"></textarea>
          </div>
          <div class="form-group">
            <label>Current Files</label>
            <div id="edit-current-files" style="margin-top: 5px;"></div>
          </div>
          <div class="form-group">
            <label for="edit-files">Add Investigation Files</label>
            <input id="edit-files" name="files" type="file" multiple>
          </div>
          <button type="button" onclick="saveEditedCase()" class="save-btn">Save Changes</button>
          <button type="button" onclick="clearEditForm()" style="background-color: #757575;">Clear Form</button>
          <button type="button" onclick="openTab(event, 'cases')">Back</button>
        </form>
      </div>

      <div id="staff-search" class="tabcontent">
        <h2>Staff Search</h2>
        <div class="form-group">
          <label for="staff-search-input">Search by Staff No.</label>
          <input id="staff-search-input" placeholder="Enter staff number" onkeyup="searchStaff()">
        </div>
        <button id="export-staff-btn" onclick="exportStaffCases()">Export Staff Cases</button>
        <div class="scrollable">
          <table class="case-table" id="staff-case-list">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date of Occurrence</th>
                <th>Type</th>
                <th>Status</th>
                <th>Staff No.</th>
                <th>Officer</th>
                <th>Summary</th>
                <th>Breaches of Standards</th>
                <th>Investigator</th>
                <th>Severity</th>
                <th>Section 17</th>
                <th>Police Friend</th>
                <th>Section 18</th>
                <th>Interview</th>
                <th>IO Report</th>
                <th>RA Assessment</th>
                <th>Notice of Referral</th>
                <th>Section 24 Reply</th>
                <th>Misconduct Mtg</th>
                <th>Misconduct Outcome</th>
                <th>GM Hearing</th>
                <th>Hearing Outcome</th>
                <th>Appeal Made</th>
                <th>Appeal Letter</th>
                <th>Appeal Hearing</th>
                <th>Appeal Outcome</th>
                <th>Comments</th>
                <th>Files</th>
                <th class="frozen">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="staff-case-details" class="case-details" style="display: none;"></div>
      </div>

      <div id="admin-area" class="tabcontent">
        <h2>Admin Area</h2>
        <div class="tabs">
          <button class="tablink" onclick="openAdminTab(event, 'user-management')" id="defaultAdminOpen">User Management</button>
          <button class="tablink" onclick="openAdminTab(event, 'audit-report')">Audit Report</button>
          <button class="tablink" id="error-log-tab" onclick="openAdminTab(event, 'error-log')">Error Log</button>
          <button class="tablink" onclick="openAdminTab(event, 'user-permissions')">User Permissions</button>
        </div>
      
        <div id="user-management" class="admin-tabcontent">
          <h3>Create New User</h3>
          <div class="form-group">
            <label for="new-username">Username</label>
            <input id="new-username" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label for="new-email">Email</label>
            <input id="new-email" placeholder="Enter email">
          </div>
          <div class="form-group">
            <label for="new-name">Name</label> 
            <input id="new-name" placeholder="Enter full name">
          </div>
          <div class="form-group">
            <label for="new-role">Role</label>
            <select id="new-role">
              <option value="admin">Admin</option>
              <option value="psd admin">PSD Admin</option>
              <option value="psd">PSD</option>
              <option value="auditor">Auditor</option>
            </select>
          </div>
          <button onclick="createUser()">Create User</button>
          <p id="user-create-result"></p>
      
          <h3>Manage Users</h3>
          <div class="scrollable">
            <table class="user-table" id="user-list">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Name</th> <!-- Added Name column -->
                  <th>Email</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      
        <div id="audit-report" class="admin-tabcontent" style="display: none;">
          <h3>Audit Report</h3>
          <button onclick="exportAuditReport()">Export Audit Report</button>
          <div class="scrollable">
            <table class="audit-table" id="audit-list">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Details</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      
        <div id="error-log" class="admin-tabcontent" style="display: none;">
          <h3>Error Log</h3>
          <div class="scrollable">
            <table class="audit-table" id="error-list">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Error Description</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      
        <div id="user-permissions" class="admin-tabcontent" style="display: none;">
          <h3>User Permissions</h3>
          
          <!-- Form to Assign/Update Permissions -->
          <div class="form-group">
            <h4>Assign/Update Permission</h4>
            <form id="permission-form">
              <div class="form-group">
                <label for="perm-username">PSD User:</label>
                <select id="perm-username" name="username" required></select>
              </div>
              <div class="form-group">
                <label for="perm-caseId">Case:</label>
                <select id="perm-caseId" name="caseId" required></select>
              </div>
              <div class="form-group">
                <label><input type="checkbox" id="perm-canView" name="canView" checked> Can View</label>
                <label><input type="checkbox" id="perm-canEdit" name="canEdit"> Can Edit</label>
              </div>
              <button type="submit">Assign/Update Permission</button>
            </form>
          </div>
        
          <!-- Permissions Table -->
          <div class="scrollable-table">
            <h4>Current Permissions</h4>
            <table id="permissions-table" class="case-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Case ID</th>
                  <th>Can View</th>
                  <th>Can Edit</th>
                  <th>Assigned By</th>
                  <th>Assigned Date</th>
                  <th class="frozen">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div> <!-- Closing #admin-area -->

      <div id="officer-profiles" class="tabcontent">
        <h2>Officer Profiles</h2>
        <div class="form-group">
          <label for="officer-search">Search Officers</label>
          <input id="officer-search" placeholder="Search by staff number or name" onkeyup="searchOfficers()">
        </div>
        <div class="scrollable-table">
          <table class="officer-table" id="officer-list">
            <thead>
              <tr>
                <th>Staff No.</th>
                <th>Name</th>
                <th>Joining Date</th>
                <th>Rank</th>
                <th>Date of Birth</th>
                <th>Age</th>
                <th>Years of Service</th>
                <th class="frozen">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="officer-details" class="case-details" style="display: none;"></div>
      </div>

      <div id="disclosure-area" class="tabcontent">
        <h2>Discipline Disclosure Report</h2>
        <form id="disclosure-form">
          <div class="form-group">
            <label for="rci-no">RCI No.</label>
            <input id="rci-no" name="rciNo" placeholder="Enter RCI No.">
          </div>
          <div class="form-group">
            <label for="rgp-no">RGP No.</label>
            <input id="rgp-no" name="rgpNo" placeholder="Enter RGP No.">
          </div>
          <div class="form-group">
            <label for="rto-no">RTO No.</label>
            <input id="rto-no" name="rtoNo" placeholder="Enter RTO No.">
          </div>
          <div class="form-group">
            <label for="ob-no">OB No.</label>
            <input id="ob-no" name="obNo" placeholder="Enter OB No.">
          </div>
          <div class="form-group">
            <label for="case-name">Case Name (Rex V _____)</label>
            <input id="case-name" name="caseName" placeholder="Enter Case Name (e.g., Rex V Smith)" required>
          </div>
          <div class="form-group">
            <label for="oic-name">OIC Name</label>
            <input id="oic-name" name="oicName" placeholder="Enter Officer in Charge Name" required>
          </div>
          <div class="form-group">
            <label for="section">Section</label>
            <input id="section" name="section" placeholder="Enter Section">
          </div>
          <div id="disclosure-officer-list">
            <h3>Officers Involved</h3>
            <div class="officer-entry">
              <div class="form-group">
                <label for="officer-name-0">Officer Name</label>
                <input id="officer-name-0" name="officers[0][name]" placeholder="Enter Officer Name" required>
              </div>
              <div class="form-group">
                <label for="staff-id-0">Staff ID Number</label>
                <input id="staff-id-0" name="officers[0][staffId]" placeholder="Enter Staff ID" required>
              </div>
              <div class="form-group">
                <label for="rank-collar-0">Rank & Collar Number</label>
                <input id="rank-collar-0" name="officers[0][rankCollar]" placeholder="Enter Rank & Collar No." required>
              </div>
              <button type="button" class="delete-btn" onclick="removeOfficer(0)" style="display:none;">Remove</button>
            </div>
          </div>
          <button type="button" onclick="addOfficer()">Add Officer</button>
          <button type="button" onclick="generateDisclosureReport()">Generate Report</button>
          <button type="button" onclick="resetDisclosureForm()">Reset</button>
        </form>
        <div id="disclosure-result"></div>
      </div>

      
  <script>

const BASE_URL = window.location.origin;

// Object to track failed attempts
const loginAttempts = {
  users: {}, // { username: { attempts: number, locked: boolean, lockTime: timestamp } }
  ips: {}    // { ip: { attempts: number, blocked: boolean, blockTime: timestamp } }
};

// Configuration
const MAX_USER_ATTEMPTS = 5;      // Lock user after 5 fails
const MAX_IP_ATTEMPTS = 20;       // Block IP after 20 fails
const USER_LOCK_DURATION = 15 * 60 * 1000; // 15 minutes in ms
const IP_BLOCK_DURATION = 60 * 60 * 1000;  // 1 hour in ms

window.addEventListener('beforeunload', (e) => {
  console.log('Page unloading, state:', { isLoggedIn, userRole });
});
    let chartInstances = {};
    let isLoggedIn = false;
    let loginInProgress = false;
    let allCases = [];
    let editingCaseId = null;
    let detailedStats = {};
    let staffCases = [];
    let userRole = '';
    let userName = '';
    let inactivityTimeout;
    let currentUser = '';
    let timeoutId;
    let casesPerYearChart;
    const INACTIVITY_LIMIT = 2 * 60 * 1000; // 2 minutes in milliseconds
    let officerCount;
    let allOfficers = [];
    let currentCaseIdForAddOfficer = null;

function resetTimeout() {
  clearTimeout(timeoutId);
  if (isLoggedIn) {
    timeoutId = setTimeout(() => {
      console.log('Inactivity timeout triggered - logging out');
      logout();
    }, INACTIVITY_LIMIT);
  }
}

function setupInactivityTimeout() {
  // Remove any existing listeners to avoid duplicates
  document.removeEventListener('mousemove', resetTimeout);
  document.removeEventListener('mousedown', resetTimeout);
  document.removeEventListener('keypress', resetTimeout);

  // Add new listeners
  document.addEventListener('mousemove', resetTimeout);
  document.addEventListener('mousedown', resetTimeout);
  document.addEventListener('keypress', resetTimeout);
  resetTimeout(); // Start the timer
}

function stopInactivityTimeout() {
  clearTimeout(timeoutId);
  document.removeEventListener('mousemove', resetTimeout);
  document.removeEventListener('mousedown', resetTimeout);
  document.removeEventListener('keypress', resetTimeout);
}

    function formatDate(dateStr) {
  if (dateStr === undefined || dateStr === null || dateStr === '') return ''; // Return empty string for missing values
  const date = new Date(dateStr);
  if (isNaN(date)) {
    console.warn('Invalid date format:', dateStr);
    return dateStr; // Fallback to raw string if invalid
  }
  return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

    function checkSession(callback) {
  fetch(`${BASE_URL}/session-status`, { credentials: 'include' })
    .then(response => {
      console.log('Session status:', response.status);
      if (!response.ok) throw new Error('Fetch failed: ' + response.status);
      return response.json();
    })
    .then(data => {
      console.log('Session data:', data);
      if (data.loggedIn) {
        isLoggedIn = true;
        currentUser = data.username;
        userRole = data.role;
        userName = data.name; // Store name
        console.log('User role set to:', userRole);
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('portal').style.display = 'block';
        document.getElementById('user-info').innerText = `Logged in as: ${currentUser}`;
        setupInactivityTimeout(); // Start timer if session is active
        
        // Define tab visibility by role
        const tabVisibility = {
          'admin': {
            'add-case-tab': 'inline-block',
            'edit-case-tab': 'none',
            'stats-tab': 'inline-block',
            'chart-tab-btn': 'inline-block',
            'admin-tab': 'inline-block',
            'officer-profiles-tab': 'inline-block',
            'disclosure-tab': 'inline-block' // Add this
          },
          'psd admin': {
            'add-case-tab': 'inline-block',
            'edit-case-tab': 'none',
            'stats-tab': 'inline-block',
            'chart-tab-btn': 'inline-block',
            'admin-tab': 'inline-block',
            'officer-profiles-tab': 'inline-block',
            'disclosure-tab': 'inline-block' // Add this
          },
          'psd': {
            'add-case-tab': 'inline-block',
            'edit-case-tab': 'inline-block',
            'stats-tab': 'none',
            'chart-tab-btn': 'none',
            'admin-tab': 'none',
            'officer-profiles-tab': 'none',
            'disclosure-tab': 'none' // Add this
          },
          'auditor': {
            'add-case-tab': 'none',
            'edit-case-tab': 'none',
            'stats-tab': 'inline-block',
            'chart-tab-btn': 'inline-block',
            'admin-tab': 'none',
            'officer-profiles-tab': 'none',
            'disclosure-tab': 'none' // Add this
          }
        };

        const tabs = tabVisibility[userRole] || {};
        console.log('Applying tab visibility for', userRole, ':', tabs);
        document.getElementById('add-case-tab').style.display = tabs['add-case-tab'] || 'none';
        document.getElementById('edit-case-tab').style.display = tabs['edit-case-tab'] || 'none';
        document.getElementById('stats-tab').style.display = tabs['stats-tab'] || 'none';
        document.getElementById('chart-tab-btn').style.display = tabs['chart-tab-btn'] || 'none';
        document.getElementById('admin-tab').style.display = tabs['admin-tab'] || 'none';
        document.getElementById('officer-profiles-tab').style.display = tabs['officer-profiles-tab'] || 'none';
        document.getElementById('disclosure-tab').style.display = tabs['disclosure-tab'] || 'none'; // Add this
        document.getElementById('cases').style.display = 'block'; // Always visible

        loadCases();
        if (userRole === 'admin' || userRole === 'psd admin' || userRole === 'auditor') {
          loadDetailedStats();
          loadCharts();
        }
        if (userRole === 'admin' || userRole === 'psd admin') {
          loadOfficers();
        }
        if (callback) callback();
      } else {
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('portal').style.display = 'none';
        if (callback) callback();
      }
    })
    .catch(error => {
      console.error('Session check error:', error);
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('portal').style.display = 'none';
      if (callback) callback();
    });
}

function setupPortal() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('reset-password-section').style.display = 'none';
  document.getElementById('portal').style.display = 'block';
  document.getElementById('user-info').innerText = `Logged in as: ${currentUser}`;

  if (userRole === 'admin' || userRole === 'psd admin') {
    document.getElementById('admin-tab').style.display = 'inline-block';
    document.getElementById('add-case-tab').style.display = 'inline-block';
    document.getElementById('edit-case-tab').style.display = 'inline-block';
    document.getElementById('stats-tab').style.display = 'inline-block';
    document.getElementById('chart-tab-btn').style.display = 'inline-block';
    document.getElementById('export-staff-btn').style.display = 'inline-block'; // Visible for admin/psd admin
  } else if (userRole === 'psd') {
    document.getElementById('add-case-tab').style.display = 'inline-block';
    document.getElementById('edit-case-tab').style.display = 'inline-block';
    document.getElementById('export-staff-btn').style.display = 'inline-block'; // Visible for psd
  } else if (userRole === 'auditor') {
    document.getElementById('stats-tab').style.display = 'inline-block';
    document.getElementById('chart-tab-btn').style.display = 'inline-block';
    document.getElementById('export-staff-btn').style.display = 'none'; // Hidden for auditors
  }

  loadCases();
  document.getElementById('defaultOpen').click();
  setupInactivityTimeout(); // Fixed: Use the correct function name
}

// Enable/disable login button based on checkbox
function toggleLoginButton() {
  const agreeCheckbox = document.getElementById('disclaimer-agree');
  const loginButton = document.getElementById('login-btn');
  loginButton.disabled = !agreeCheckbox.checked;
}

function login() {
  const username = document.getElementById('username').value.trim(); // Added .trim()
  const password = document.getElementById('password').value;
  const agreeCheckbox = document.getElementById('disclaimer-agree');
  const errorElement = document.getElementById('login-error');

  // Check disclaimer agreement
  if (!agreeCheckbox.checked) {
    errorElement.innerText = 'You must agree to the disclaimer to log in.';
    return;
  }

  // Optional: Basic input validation
  if (!username || !password) {
    errorElement.innerText = 'Please enter both username and password.';
    return;
  }

  fetch(`${BASE_URL}/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password }),
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { throw err; }); // Throw error for non-2xx responses
      }
      return response.json();
    })
    .then(data => {
      if (data.loggedIn) {
        isLoggedIn = true;
        currentUser = username;
        userRole = data.role;
        userName = data.name;
        errorElement.innerText = '';
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('portal').style.display = 'block';
        document.getElementById('user-info').innerText = `Logged in as: ${username}`;

        // Log disclaimer agreement to audit
        console.log('Attempting to log disclaimer agreement for', username);
        fetch(`${BASE_URL}/audit/extract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'login',
            identifier: username,
            details: 'User agreed to disclaimer and logged in'
          }),
          credentials: 'include'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Audit log response not OK: ' + response.status);
            }
            return response.json();
          })
          .then(() => console.log('Disclaimer agreement successfully audited for', username))
          .catch(error => console.error('Failed to log disclaimer agreement:', error));

        if (data.needsReset) {
          document.getElementById('portal').style.display = 'none';
          document.getElementById('reset-password-section').style.display = 'block';
        } else {
          setupInactivityTimeout();

          const tabVisibility = {
            'admin': {
              'add-case-tab': 'inline-block',
              'edit-case-tab': 'none',
              'stats-tab': 'inline-block',
              'chart-tab-btn': 'inline-block',
              'admin-tab': 'inline-block',
              'officer-profiles-tab': 'inline-block',
              'disclosure-tab': 'inline-block'
            },
            'psd admin': {
              'add-case-tab': 'inline-block',
              'edit-case-tab': 'none',
              'stats-tab': 'inline-block',
              'chart-tab-btn': 'inline-block',
              'admin-tab': 'inline-block',
              'officer-profiles-tab': 'inline-block',
              'disclosure-tab': 'inline-block'
            },
            'psd': {
              'add-case-tab': 'inline-block',
              'edit-case-tab': 'inline-block',
              'stats-tab': 'none',
              'chart-tab-btn': 'none',
              'admin-tab': 'none',
              'officer-profiles-tab': 'none',
              'disclosure-tab': 'none'
            },
            'auditor': {
              'add-case-tab': 'none',
              'edit-case-tab': 'none',
              'stats-tab': 'inline-block',
              'chart-tab-btn': 'inline-block',
              'admin-tab': 'none',
              'officer-profiles-tab': 'none',
              'disclosure-tab': 'none'
            }
          };

          const tabs = tabVisibility[userRole] || {};
          console.log('Applying tab visibility for', userRole, ':', tabs);
          document.getElementById('add-case-tab').style.display = tabs['add-case-tab'] || 'none';
          document.getElementById('edit-case-tab').style.display = tabs['edit-case-tab'] || 'none';
          document.getElementById('stats-tab').style.display = tabs['stats-tab'] || 'none';
          document.getElementById('chart-tab-btn').style.display = tabs['chart-tab-btn'] || 'none';
          document.getElementById('admin-tab').style.display = tabs['admin-tab'] || 'none';
          document.getElementById('officer-profiles-tab').style.display = tabs['officer-profiles-tab'] || 'none';
          document.getElementById('disclosure-tab').style.display = tabs['disclosure-tab'] || 'none';

          loadCases();
          openTab({ currentTarget: document.getElementById('defaultOpen') }, 'cases');
        }
      } else {
        throw new Error(data.error || 'Login failed'); // Trigger catch block for server errors
      }
    })
    .catch(error => {
      console.error('Login error:', error);
      if (error.error === 'user_locked') {
        const timeLeft = Math.ceil(error.lockRemaining / 60000);
        errorElement.innerText = `Account locked due to too many failed attempts. Try again in ${timeLeft} minutes.`;
      } else if (error.error === 'ip_blocked') {
        const timeLeft = Math.ceil(error.blockRemaining / 60000);
        errorElement.innerText = `IP blocked due to excessive attempts. Try again in ${timeLeft} minutes.`;
      } else {
        errorElement.innerText = `Login failed: ${error.message || 'An error occurred'}`;
      }
    });
}

// Keep your toggleLoginButton function unchanged
function toggleLoginButton() {
  const agreeCheckbox = document.getElementById('disclaimer-agree');
  const loginButton = document.getElementById('login-btn');
  loginButton.disabled = !agreeCheckbox.checked;
}

document.addEventListener('DOMContentLoaded', () => {
  const agreeCheckbox = document.getElementById('disclaimer-agree');
  if (agreeCheckbox) {
    agreeCheckbox.checked = false;
    toggleLoginButton();
  }
});

    function resetPassword() {
      const newPassword = document.getElementById('new-password').value;
      if (!newPassword) {
        document.getElementById('reset-error').innerText = 'Please enter a new password';
        return;
      }
      fetch(`${BASE_URL}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword }),
        credentials: 'include'
      })
        .then(response => {
          console.log('Reset password response status:', response.status);
          if (!response.ok) throw new Error('Reset failed: ' + response.status);
          return response.json();
        })
        .then(data => {
          console.log('Reset password response:', data);
          document.getElementById('reset-error').innerText = 'Password reset successful. Logging in...';
          setTimeout(setupPortal, 1000);
        })
        .catch(error => {
          console.error('Reset password error:', error);
          document.getElementById('reset-error').innerText = 'Failed to reset password: ' + error.message;
        });
    }

    function showResetRequest() {
      document.getElementById('reset-request').style.display = 'block';
    }

    function requestPasswordReset() {
      const username = document.getElementById('reset-username').value;
      const email = document.getElementById('reset-email').value;
      if (!username || !email) {
        document.getElementById('login-error').innerText = 'Please enter both username and email';
        return;
      }
      fetch(`${BASE_URL}/request-password-reset`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email })
      })
        .then(response => {
          console.log('Reset request response status:', response.status);
          if (!response.ok) return response.json().then(err => { throw new Error(err.error); });
          return response.json();
        })
        .then(data => {
          console.log('Reset request response:', data);
          document.getElementById('login-error').innerText = `One-time password generated: ${data.oneTimePassword}. Use this to log in and reset your password.`;
          document.getElementById('reset-request').style.display = 'none';
        })
        .catch(error => {
          console.error('Reset request error:', error);
          document.getElementById('login-error').innerText = 'Failed to request reset: ' + error.message;
        });
    }

    function logout() {
  console.log('Logging out');
  fetch(`${BASE_URL}/logout`, {
    method: 'POST',
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('Logout failed: ' + response.status);
      console.log('Logout request succeeded');
      return response.json();
    })
    .then(data => {
      // Clear session state
      isLoggedIn = false;
      userRole = '';
      currentUser = '';
      allCases = [];
      detailedStats = {};
      staffCases = [];
      chartInstances = {};
      editingCaseId = null;

      // Delay UI cleanup slightly to allow async operations to finish
      setTimeout(() => {
        const caseListTbody = document.getElementById('case-list')?.getElementsByTagName('tbody')[0];
        if (caseListTbody) caseListTbody.innerHTML = '';

        const staffCaseListTbody = document.getElementById('staff-case-list')?.getElementsByTagName('tbody')[0];
        if (staffCaseListTbody) staffCaseListTbody.innerHTML = '';

        const caseDetails = document.getElementById('case-details');
        if (caseDetails) {
          caseDetails.innerHTML = '';
          caseDetails.style.display = 'none';
        }

        const portal = document.getElementById('portal');
        if (portal) portal.style.display = 'none';

        const loginSection = document.getElementById('login-section');
        if (loginSection) loginSection.style.display = 'block';

        const resetPasswordSection = document.getElementById('reset-password-section');
        if (resetPasswordSection) resetPasswordSection.style.display = 'none';

        const userInfo = document.getElementById('user-info');
        if (userInfo) userInfo.innerText = '';

        const usernameInput = document.getElementById('username');
        if (usernameInput) usernameInput.value = '';

        const passwordInput = document.getElementById('password');
        if (passwordInput) passwordInput.value = '';

        stopInactivityTimeout();
        console.log('Logged out, clearing data');
      }, 100); // 100ms delay
    })
    .catch(error => {
      console.error('Logout error:', error);
      // Clear state even on error
      isLoggedIn = false;
      userRole = '';
      currentUser = '';
      allCases = [];
      detailedStats = {};
      staffCases = [];
      chartInstances = {};
      editingCaseId = null;

      setTimeout(() => {
        const caseListTbody = document.getElementById('case-list')?.getElementsByTagName('tbody')[0];
        if (caseListTbody) caseListTbody.innerHTML = '';

        const staffCaseListTbody = document.getElementById('staff-case-list')?.getElementsByTagName('tbody')[0];
        if (staffCaseListTbody) staffCaseListTbody.innerHTML = '';

        const caseDetails = document.getElementById('case-details');
        if (caseDetails) {
          caseDetails.innerHTML = '';
          caseDetails.style.display = 'none';
        }

        const portal = document.getElementById('portal');
        if (portal) portal.style.display = 'none';

        const loginSection = document.getElementById('login-section');
        if (loginSection) loginSection.style.display = 'block';

        const resetPasswordSection = document.getElementById('reset-password-section');
        if (resetPasswordSection) resetPasswordSection.style.display = 'none';

        const loginError = document.getElementById('login-error');
        if (loginError) loginError.innerText = 'Logout failed: ' + error.message;

        const userInfo = document.getElementById('user-info');
        if (userInfo) userInfo.innerText = '';

        const usernameInput = document.getElementById('username');
        if (usernameInput) usernameInput.value = '';

        const passwordInput = document.getElementById('password');
        if (passwordInput) passwordInput.value = '';

        stopInactivityTimeout();
        console.log('Logout failed, clearing data');
      }, 100);
    })
    .finally(() => {
      // Ensure any lingering promises are caught
      return Promise.resolve();
    });
}

function changePassword() {
  const username = currentUser;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const errorElement = document.getElementById('reset-error');

  if (newPassword !== confirmPassword) {
    errorElement.innerText = 'Passwords do not match';
    return;
  }

  fetch(`${BASE_URL}/change-password`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, newPassword }),
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('Password change failed');
      return response.json();
    })
    .then(data => {
      errorElement.innerText = '';
      alert('Password changed successfully! Please log in again.');
      document.getElementById('reset-password-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
    })
    .catch(error => {
      console.error('Change password error:', error);
      errorElement.innerText = 'Failed to change password: ' + error.message;
    });
}

function openTab(evt, tabName, isProfileView = false) {
  const tabcontent = document.getElementsByClassName('tabcontent');
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = 'none';
  }
  const tablinks = document.getElementsByClassName('tablink');
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(' active', '');
  }
  const targetTab = document.getElementById(tabName);
  if (!targetTab) {
    console.error(`Tab ${tabName} not found`);
    return;
  }
  targetTab.style.display = 'block';
  evt.currentTarget.className += ' active';

  // Role-based visibility
  if (isLoggedIn) {
    document.getElementById('add-case-tab').style.display = (userRole === 'admin' || userRole === 'psd admin' || userRole === 'psd') ? 'block' : 'none';
    document.getElementById('stats-tab').style.display = (userRole === 'admin' || userRole === 'psd admin') ? 'block' : 'none';
    document.getElementById('chart-tab-btn').style.display = (userRole === 'admin' || userRole === 'psd admin') ? 'block' : 'none';
    document.getElementById('admin-tab').style.display = (userRole === 'admin' || userRole === 'psd admin') ? 'block' : 'none';
    document.getElementById('disclosure-tab').style.display = (userRole === 'admin' || userRole === 'psd admin') ? 'block' : 'none';
  }

  // Tab-specific logic
  if (tabName === 'cases') {
    loadCases();
    const caseDetails = document.getElementById('case-details');
    const caseList = document.getElementById('case-list');
    if (caseDetails && caseDetails.style.display === 'block') {
      caseList.style.display = 'none';
    } else {
      caseList.style.display = 'table';
    }
  } else if (tabName === 'officer-profiles') {
    const officerDetails = document.getElementById('officer-details');
    if (!isProfileView) {
      loadOfficers();
      if (officerDetails) officerDetails.style.display = 'none';
    }
  } else if (tabName === 'chart-tab') {
    loadCharts();
  } else if (tabName === 'stats') {
    loadDetailedStats();
  } else if (tabName === 'staff-search') {
    loadOfficers();
  } else if (tabName === 'admin-area') {
    openAdminTab(evt, 'user-management');
  } else if (tabName === 'disclosure-area') {
    const officerList = document.getElementById('disclosure-officer-list');
    officerCount = officerList ? officerList.getElementsByClassName('officer-entry').length + 1 : 1;
    resetDisclosureForm();
  }

  // Reset disclosure form when leaving disclosure-area
  if (tabName !== 'disclosure-area') {
    const form = document.getElementById('disclosure-form');
    if (form) {
      form.reset();
      officerCount = 1;
      const officerList = document.getElementById('disclosure-officer-list');
      if (officerList) {
        officerList.innerHTML = '';
        addOfficer();
      }
      document.getElementById('disclosure-result').innerText = '';
    }
  }

  targetTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function loadCases() {
  if (!isLoggedIn) {
    console.log('Not logged in, skipping loadCases');
    return;
  }
  fetch(`${BASE_URL}/cases`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Fetch failed: ' + response.status);
      return response.json();
    })
    .then(data => {
      console.log('Cases data:', data);
      const tbody = document.getElementById('case-list').getElementsByTagName('tbody')[0];
      if (!tbody) {
        console.error('Case list tbody not found');
        return;
      }
      tbody.innerHTML = '';
      allCases = Array.isArray(data) ? data : [];
      if (allCases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="29">No cases found</td></tr>';
        return;
      }
      renderCaseTable(allCases); // Initial render of all cases
    })
    .catch(error => console.error('Load cases error:', error));
}

// Add renderCaseTable function (place this after loadCases in your script)
function renderCaseTable(casesToDisplay) {
  const tbody = document.getElementById('case-list').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  if (casesToDisplay.length === 0) {
    tbody.innerHTML = '<tr><td colspan="29">No cases match the selected status</td></tr>';
    return;
  }
  let html = '';
  casesToDisplay.forEach(c => {
    const officers = c.officers && c.officers.length > 0 ? c.officers : [{}];
    const filesDisplay = c.files && c.files.length > 0 ? '' : '';
    officers.forEach((officerData, index) => {
      let breaches = '';
      try {
        const parsed = officerData.breachOfStandards ? JSON.parse(officerData.breachOfStandards) : [];
        breaches = Array.isArray(parsed) ? parsed.join(', ') : (parsed || officerData.breachOfStandards || '');
      } catch (e) {
        breaches = officerData.breachOfStandards || '';
      }
      let actions = `
        <button class="view-btn" onclick="viewCase('${c.id}', '${officerData.id}')">View</button>
      `;
      // Role-based edit button logic
      if (userRole === 'admin' || userRole === 'psd admin') {
        actions += `
          <button class="edit-btn" onclick="editCase('${c.id}', '${officerData.id}')">Edit</button>
        `;
      } else if (userRole === 'psd' && c.canEdit === 1) {
        actions += `
          <button class="edit-btn" onclick="editCase('${c.id}', '${officerData.id}')">Edit</button>
        `;
      }
      // Delete and Add Officer buttons for admin/psd admin
      if (userRole === 'admin' || userRole === 'psd admin') {
        const officerId = officerData.id || 'unknown';
        actions += `
          <button class="delete-btn" onclick="deleteCaseOfficer('${c.id}', '${officerId}')">Delete</button>
        `;
        console.log('Delete button set - Case ID:', c.id, 'Officer ID:', officerId);
        if (index === 0) {
          actions += `
            <button class="add-officer-btn" onclick="showAddOfficerForm('${c.id}')" style="background-color: #4CAF50;">Add Officer</button>
          `;
        }
      }

      // Conditional formatting for Section 18 Reply Date
      const section18Days = calculateWorkingDays(officerData.section17Date, officerData.section18Date);
      const section18Style = section18Days !== null
        ? (section18Days <= 10 ? 'color: green;' : 'color: red;')
        : '';

      // Conditional formatting for Notice of Referral
      const noticeDays = calculateWorkingDays(officerData.ioReportDate, officerData.officerAdvisedOfReferral);
      const noticeStyle = noticeDays !== null
        ? (noticeDays <= 15 ? 'color: green;' : 'color: red;')
        : '';

      // Conditional formatting for Section 24 Reply
      const section24Days = calculateWorkingDays(officerData.officerAdvisedOfReferral, officerData.section24ReplyToRA);
      const section24Style = section24Days !== null
        ? (section24Days <= 14 ? 'color: green;' : 'color: red;')
        : '';

      html += `
        <tr>
          ${index === 0 ? `<td rowspan="${officers.length}" style="position: sticky; left: 0; background-color: #fff; z-index: 1;"><a href="#" onclick="viewCase('${c.id}', null, true); return false;">${c.id}</a></td>` : ''}
          <td>${formatDate(officerData.dateOccurrence || '')}</td>
          <td>${officerData.type || ''}</td>
          <td>${officerData.status || ''}</td>
          <td>${officerData.staffNo || ''}</td>
          <td><a href="#" onclick="viewOfficer('${officerData.staffNo}'); return false;">${officerData.officer || ''}</a></td>
          <td>${officerData.summary || ''}</td>
          <td>${breaches}</td>
          <td>${officerData.investigator || ''}</td>
          <td>${officerData.severity || ''}</td>
          <td>${formatDate(officerData.section17Date || '')}</td>
          <td>${officerData.policeFriend || ''}</td>
          <td style="${section18Style}">${formatDate(officerData.section18Date || '')}</td>
          <td>${formatDate(officerData.interviewDate || '')}</td>
          <td>${formatDate(officerData.ioReportDate || '')}</td>
          <td>${officerData.raAssessment || ''}</td>
          <td style="${noticeStyle}">${formatDate(officerData.officerAdvisedOfReferral || '')}</td>
          <td style="${section24Style}">${formatDate(officerData.section24ReplyToRA || '')}</td>
          <td>${formatDate(officerData.misconductMeetingDate || '')}</td>
          <td>${officerData.misconductOutcome || ''}</td>
          <td>${formatDate(officerData.grossMisconductHearingDate)}</td>
          <td>${officerData.hearingOutcome || ''}</td>
          <td>${officerData.appealMade || ''}</td>
          <td>${formatDate(officerData.appealLetterDate || '')}</td>
          <td>${formatDate(officerData.appealHearingDate || '')}</td>
          <td>${officerData.appealOutcome || ''}</td>
          <td>${officerData.comments || ''}</td>
          <td>${filesDisplay}</td>
          <td style="position: sticky; right: 0; background-color: #fff; z-index: 1; min-width: 200px; box-shadow: -2px 0 4px rgba(0,0,0,0.1); text-align: center;">${actions}</td>
        </tr>`;
      console.log('Added row for case:', c.id, 'Officer:', officerData.officer, 'ID:', officerData.id);
    });
  });
  tbody.innerHTML = html;
  console.log('Table population complete, rows:', tbody.children.length);
}

// Add filterCasesByStatus function (place this after renderCaseTable)
function filterCasesByStatus() {
  const statusFilter = document.getElementById('status-filter').value;
  console.log('Filtering by status:', statusFilter);
  let filteredCases = allCases;
  
  if (statusFilter) {
    filteredCases = allCases
      .map(c => ({
        ...c,
        officers: c.officers.filter(o => o.status === statusFilter)
      }))
      .filter(c => c.officers.length > 0); // Only keep cases with matching officers
  }
  
  renderCaseTable(filteredCases);
}

function deleteCaseOfficer(caseId, officerId) {
  console.log('DEBUG_v3 - Attempting to delete - Case ID:', caseId, 'Officer ID:', officerId);
  if (!officerId || officerId === 'undefined' || officerId === '') {
    console.error('DEBUG_v3 - Officer ID is invalid for case:', caseId, 'Received:', officerId);
    alert('Cannot delete officer: Officer ID is missing or invalid');
    return;
  }
  if (!confirm(`Are you sure you want to delete officer with ID ${officerId} from case ${caseId}?`)) return;
  const url = `${BASE_URL}/officers/${encodeURIComponent(caseId)}/${encodeURIComponent(officerId)}`;
  console.log('DEBUG_v3 - Sending DELETE request to:', url);
  fetch(url, {
    method: 'DELETE',
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('Failed to delete officer: ' + response.status);
      console.log(`DEBUG_v3 - Officer ${officerId} deleted from case ${caseId}`);
      loadCases();
      const detailsDiv = document.getElementById('case-details');
      if (detailsDiv) {
        detailsDiv.style.display = 'none';
        detailsDiv.innerHTML = '';
      }
      alert('Officer deleted successfully');
    })
    .catch(error => {
      console.error('Delete officer error:', error);
      alert('Failed to delete officer: ' + error.message);
    });
}

// Helper function to calculate working days (Mon-Fri) between two dates
// Gibraltar public holidays for 2025
const gibraltarHolidays2025 = [
  "2025-01-01", // New Year's Day
  "2025-02-17", // Winter Midterm Bank Holiday
  "2025-04-18", // Good Friday
  "2025-04-21", // Easter Monday
  "2025-04-28", // Workers Memorial Day
  "2025-05-01", // May Day
  "2025-05-26", // Spring Bank Holiday
  "2025-06-16", // Kings Birthday (subject to change)
  "2025-08-25", // Late Summer Bank Holiday
  "2025-09-10", // Gibraltar National Day
  "2025-12-25", // Christmas Day
  "2025-12-26"  // Boxing Day
];

function calculateWorkingDays(startDateStr, endDateStr) {
  if (!startDateStr || !endDateStr) return null; // Return null if either date is missing

  const startDate = new Date(startDateStr);
  const endDate = new Date(endDateStr);
  if (isNaN(startDate) || isNaN(endDate)) return null; // Invalid dates

  let workingDays = 0;
  let currentDate = new Date(startDate);

  while (currentDate <= endDate) {
    const dayOfWeek = currentDate.getDay();
    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude Sunday (0) and Saturday (6)
      workingDays++;
    }
    currentDate.setDate(currentDate.getDate() + 1);
  }

  // Subtract 1 if start and end dates are the same day (no "working days" between)
  return workingDays > 0 ? workingDays - 1 : 0;
}

function renderCaseDetailsUpdated(caseItem, caseId, officerId, allOfficers = false) {
  console.log('caseItem:', caseItem);
  console.log('Using caseItem.id:', caseItem.id);
  const detailsDiv = document.getElementById('case-details');
  if (!detailsDiv) return;

  // Officer selection
  const officersToRender = allOfficers 
    ? caseItem.officers || [] 
    : [caseItem.officers?.find(o => o.id == officerId) || caseItem.officers?.[0] || {}];

  // Officer HTML with minimal template literals
  const officersHTML = officersToRender.map(officerData => {
    const breaches = parseBreaches(officerData.breachOfStandards);
    const styles = {
      section18: getStyle(calculateWorkingDays(officerData.section17Date, officerData.section18Date), 10),
      notice: getStyle(calculateWorkingDays(officerData.ioReportDate, officerData.officerAdvisedOfReferral), 15),
      section24: getStyle(calculateWorkingDays(officerData.officerAdvisedOfReferral, officerData.section24ReplyToRA), 14)
    };

    return `
      <div class="officer-details" style="border:1px solid #ddd;padding:10px;margin-bottom:10px">
        <h4>${escapeHtml(officerData.officer || 'Unnamed')} (Staff No: ${escapeHtml(officerData.staffNo || '')})</h4>
        <p><b>Date of Occurrence:</b> ${formatDate(officerData.dateOccurrence)}</p>
        <p><b>Type:</b> ${escapeHtml(officerData.type || '')}</p>
        <p><b>Status:</b> ${escapeHtml(officerData.status || '')}</p>
        <p><b>Summary:</b> ${escapeHtml(officerData.summary || '')}</p>
        <p><b>Breaches:</b> ${escapeHtml(breaches)}</p>
        <p><b>Investigator:</b> ${escapeHtml(officerData.investigator || '')}</p>
        <p><b>Severity:</b> ${escapeHtml(officerData.severity || '')}</p>
        <p><b>Section 17 Delivered:</b> ${formatDate(officerData.section17Date)}</p>
        <p style="${styles.section18}"><b>Section 18 Reply:</b> ${formatDate(officerData.section18Date)}</p>
        <p><b>Police Friend:</b> ${escapeHtml(officerData.policeFriend || '')}</p>
        <p><b>Interview Date:</b> ${formatDate(officerData.interviewDate)}</p>
        <p><b>IO Report Date:</b> ${formatDate(officerData.ioReportDate)}</p>
        <p><b>RA Assessment:</b> ${escapeHtml(officerData.raAssessment || '')}</p>
        <p style="${styles.notice}"><b>Notice of Referral:</b> ${formatDate(officerData.officerAdvisedOfReferral || caseItem.officerAdvisedOfReferral)}</p>
        <p style="${styles.section24}"><b>Section 24 Reply:</b> ${formatDate(officerData.section24ReplyToRA || caseItem.section24ReplyToRA)}</p>
        <p><b>Misconduct Meeting:</b> ${formatDate(officerData.misconductMeetingDate)}</p>
        <p><b>Misconduct Outcome:</b> ${escapeHtml(officerData.misconductOutcome || '')}</p>
        <p><b>Gross Misconduct Hearing:</b> ${formatDate(officerData.grossMisconductHearingDate)}</p>
        <p><b>Hearing Outcome:</b> ${escapeHtml(officerData.hearingOutcome || '')}</p>
        <p><b>Appeal Made:</b> ${escapeHtml(officerData.appealMade || '')}</p>
        <p><b>Appeal Letter:</b> ${formatDate(officerData.appealLetterDate)}</p>
        <p><b>Appeal Hearing:</b> ${formatDate(officerData.appealHearingDate)}</p>
        <p><b>Appeal Outcome:</b> ${escapeHtml(officerData.appealOutcome || '')}</p>
        <p><b>Comments:</b> ${escapeHtml(officerData.comments || '')}</p>
      </div>
    `;
  }).join('');

  // Deduped files
  const uniqueFiles = [...new Map((caseItem.files || []).map(f => [f.filePath, f])).values()];
  const filesHTML = uniqueFiles.length 
    ? uniqueFiles.map(f => `<li><a href="${BASE_URL}${escapeHtml(f.filePath)}" target="_blank" onclick="logFileView('${escapeHtml(f.filePath)}', '${escapeHtml(f.originalName)}')">${escapeHtml(f.originalName)}</a> (Uploaded: ${escapeHtml(f.uploadDate)}, By: ${escapeHtml(f.uploadedBy)})</li>`).join('')
    : '<li>No files attached</li>';

  // Final render
  detailsDiv.innerHTML = `
    <div class="case-details">
      <h3>Case Details: ${escapeHtml(caseItem.id)}</h3>
      ${officersHTML}
      <p><b>Files:</b> ${uniqueFiles.length ? '' : ''}</p>
      <h4>Detailed Files:</h4>
      <ul>${filesHTML}</ul>
      <button onclick="document.getElementById('case-details').style.display='none';document.getElementById('case-list').style.display='table'">Close</button>
    </div>
  `;
  detailsDiv.style.display = 'block';
}

// Helper functions
function parseBreaches(breaches) {
  if (!breaches) return '';
  try {
    const parsed = JSON.parse(breaches);
    return Array.isArray(parsed) ? parsed.join(', ') : String(parsed);
  } catch (e) {
    console.warn('parseBreaches failed:', breaches, e);
    return String(breaches);
  }
}

function getStyle(days, threshold) {
  return days !== null ? (days <= threshold ? 'color:green' : 'color:red') : '';
}

function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  if (typeof str !== 'string') {
    console.warn('escapeHtml received non-string:', str);
    return String(str);
  }
  return str.replace(/&/g, '&amp;')
           .replace(/</g, '&lt;')
           .replace(/>/g, '&gt;')
           .replace(/"/g, '&quot;')
           .replace(/'/g, '&#039;');
}

let searchTimeout;

function searchCases() {
  if (!isLoggedIn) {
    console.log('Not logged in, skipping searchCases');
    return;
  }

  // Clear any existing timeout to debounce the search
  clearTimeout(searchTimeout);

  searchTimeout = setTimeout(() => {
    const searchTerm = document.getElementById('search').value.toLowerCase().trim();
    const statusFilter = document.getElementById('status-filter').value;
    console.log('Search term:', searchTerm, 'Status filter:', statusFilter);

    let filteredCases = allCases;
    if (searchTerm || statusFilter) {
      filteredCases = allCases.filter(c => {
        // Case-level matches
        const caseMatches = c.id.toLowerCase().includes(searchTerm);

        // Officer-level matches, including status
        const officerMatches = c.officers && c.officers.some(o => {
          let breaches = '';
          try {
            const parsed = o.breachOfStandards ? JSON.parse(o.breachOfStandards) : [];
            breaches = Array.isArray(parsed) ? parsed.join(', ') : (parsed || o.breachOfStandards || '');
          } catch (e) {
            breaches = o.breachOfStandards || '';
          }
          return (
            (o.staffNo && o.staffNo.toLowerCase().includes(searchTerm)) ||
            (o.officer && o.officer.toLowerCase().includes(searchTerm)) ||
            (o.status && o.status.toLowerCase().includes(searchTerm)) || // Moved status to officer level
            breaches.toLowerCase().includes(searchTerm) ||
            (o.type && o.type.toLowerCase().includes(searchTerm)) ||
            (o.summary && o.summary.toLowerCase().includes(searchTerm)) ||
            (o.investigator && o.investigator.toLowerCase().includes(searchTerm)) ||
            (o.severity && o.severity.toLowerCase().includes(searchTerm)) ||
            (o.policeFriend && o.policeFriend.toLowerCase().includes(searchTerm)) ||
            (o.raAssessment && o.raAssessment.toLowerCase().includes(searchTerm)) ||
            (o.misconductOutcome && o.misconductOutcome.toLowerCase().includes(searchTerm)) ||
            (o.hearingOutcome && o.hearingOutcome.toLowerCase().includes(searchTerm)) ||
            (o.appealMade && o.appealMade.toLowerCase().includes(searchTerm)) ||
            (o.appealOutcome && o.appealOutcome.toLowerCase().includes(searchTerm)) ||
            (o.comments && o.comments.toLowerCase().includes(searchTerm))
          );
        });

        // Status filter match at officer level
        const statusMatches = !statusFilter || (c.officers && c.officers.some(o => o.status === statusFilter));

        return (caseMatches || officerMatches) && statusMatches;
      });
    }

    console.log('Filtered cases:', filteredCases);
    renderCaseTable(filteredCases);
  }, 300); // 300ms debounce delay
}

function showAddOfficerForm(caseId) {
  currentCaseIdForAddOfficer = caseId;
  document.getElementById('add-officer-modal').style.display = 'block';
  document.getElementById('modal-backdrop').style.display = 'block';
  document.getElementById('add-officer-form').reset();
}

function closeAddOfficerModal() {
  document.getElementById('add-officer-modal').style.display = 'none';
  document.getElementById('modal-backdrop').style.display = 'none';
  currentCaseIdForAddOfficer = null;
}

function submitAddOfficer() {
  if (!currentCaseIdForAddOfficer) {
    console.error('No case ID set for adding officer');
    alert('No case selected');
    return;
  }

  const form = document.getElementById('add-officer-form');
  if (!form) {
    console.error('Form #add-officer-form not found');
    alert('Form not found - please refresh and try again');
    return;
  }

  // Gather form data
  const officer = document.getElementById('add-officer-name')?.value.trim() || '';
  const staffNo = document.getElementById('add-officer-staffNo')?.value.trim() || '';
  const dateOccurrence = document.getElementById('add-officer-dateOccurrence')?.value.trim() || '';
  const type = document.getElementById('add-officer-type')?.value.trim() || '';
  const status = document.getElementById('add-officer-status')?.value.trim() || '';
  const officerAdvisedOfReferral = document.getElementById('add-officer-referral')?.value.trim() || '';
  const section24ReplyToRA = document.getElementById('add-officer-section24Reply')?.value.trim() || '';
  const summary = document.getElementById('add-officer-summary')?.value.trim() || '';
  const breachesEl = document.getElementById('add-officer-breaches');
  const breaches = breachesEl ? Array.from(breachesEl.selectedOptions).map(opt => opt.value) : [];
  const investigator = document.getElementById('add-officer-investigator')?.value.trim() || '';
  const severity = document.getElementById('add-officer-severity')?.value.trim() || '';
  const section17Date = document.getElementById('add-officer-section17Date')?.value.trim() || '';
  const policeFriend = document.getElementById('add-officer-policeFriend')?.value.trim() || '';
  const section18Date = document.getElementById('add-officer-section18Date')?.value.trim() || '';
  const interviewDate = document.getElementById('add-officer-interviewDate')?.value.trim() || '';
  const ioReportDate = document.getElementById('add-officer-ioReportDate')?.value.trim() || '';
  const raAssessment = document.getElementById('add-officer-raAssessment')?.value.trim() || '';
  const misconductMeetingDate = document.getElementById('add-officer-misconductMeetingDate')?.value.trim() || '';
  const misconductOutcome = document.getElementById('add-officer-misconductOutcome')?.value.trim() || '';
  const grossMisconductHearingDate = document.getElementById('add-officer-grossMisconductHearingDate')?.value.trim() || '';
  const hearingOutcome = document.getElementById('add-officer-hearingOutcome')?.value.trim() || '';
  const appealMade = document.getElementById('add-officer-appealMade')?.value.trim() || '';
  const appealLetterDate = document.getElementById('add-officer-appealLetterDate')?.value.trim() || '';
  const appealHearingDate = document.getElementById('add-officer-appealHearingDate')?.value.trim() || '';
  const appealOutcome = document.getElementById('add-officer-appealOutcome')?.value.trim() || '';
  const comments = document.getElementById('add-officer-comments')?.value.trim() || '';

  // Validation
  if (!officer) {
    alert('Officer name is required');
    return;
  }
  if (!staffNo) {
    alert('Staff No. is required');
    return;
  }
  if (!dateOccurrence) {
    alert('Date of Occurrence is required');
    return;
  }

  // Prepare data as JSON (instead of FormData) for consistency
  const officerData = {
    officer,
    staffNo,
    dateOccurrence,
    type,
    status,
    officerAdvisedOfReferral,
    section24ReplyToRA,
    summary,
    breachOfStandards: JSON.stringify(breaches), // Already in JSON format for server
    investigator,
    severity,
    section17Date,
    policeFriend,
    section18Date,
    interviewDate,
    ioReportDate,
    raAssessment,
    misconductMeetingDate,
    misconductOutcome,
    grossMisconductHearingDate,
    hearingOutcome,
    appealMade,
    appealLetterDate,
    appealHearingDate,
    appealOutcome,
    comments
  };

  console.log('Adding officer to case:', currentCaseIdForAddOfficer, officerData);

  const encodedCaseId = encodeURIComponent(currentCaseIdForAddOfficer);
  fetch(`${BASE_URL}/cases/${encodedCaseId}/officers`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(officerData),
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
      }
      return response.json();
    })
    .then(data => {
      console.log('Officer added:', data.message);
      closeAddOfficerModal();
      loadCases(); // Refresh Cases tab
      // If in Search Staff tab, optionally call: searchStaff();
      alert(data.message || 'Officer added successfully');
    })
    .catch(error => {
      console.error('Add officer error:', error);
      alert('Failed to add officer: ' + error.message);
    });
}

function addCase() {
  if (!isLoggedIn) {
    console.log('Not logged in, skipping addCase');
    return;
  }
  if (userRole === 'auditor') {
    console.log('Auditors cannot add cases');
    alert('You do not have permission to add cases.');
    return;
  }
  const form = document.getElementById('add-case-form');
  let id = document.getElementById('add-id').value.trim();
  const staffNo = document.getElementById('add-staffNo').value.trim(); // Ensure trim
  const officer = document.getElementById('add-officer').value.trim();
  const breaches = Array.from(document.getElementById('add-breachOfStandards').selectedOptions).map(opt => opt.value);
  const status = document.getElementById('add-status').value.trim();

  if (!id.startsWith('PSD/')) {
    id = 'PSD/' + id;
  }

  if (!id || !staffNo || !officer || !status) { // Already checks status
    alert('Please fill in all required fields: Case ID, Staff No., Officer, and Status');
    return;
  }

  const formData = new FormData(form);
  formData.set('id', id);
  formData.set('breachOfStandards', JSON.stringify(breaches));
  formData.set('staffNo', staffNo); // Ensure staffNo is set

  console.log('FormData contents for add:');
  for (let [key, value] of formData.entries()) {
    if (key === 'files' && value instanceof File && value.size > 0) {
      console.log(`${key}: File - ${value.name}, Size: ${value.size} bytes`);
    } else {
      console.log(`${key}: ${value}`);
    }
  }

  fetch(`${BASE_URL}/cases`, {
    method: 'POST',
    body: formData,
    credentials: 'include'
  })
  .then(response => {
    console.log('Add case response status:', response.status);
    if (!response.ok) {
      return response.json().then(err => { throw new Error(err.error || 'Server error: ' + response.status); });
    }
    return response.json();
  })
  .then(data => {
    console.log('Case added, reloading cases...');
    loadCases();
    clearAddForm();
    alert(data.message || 'Case added successfully');
  })
  .catch(error => {
    console.error('Add case error:', error);
    alert('Failed to add case: ' + error.message);
  });
}

function editCase(caseId, officerId) {
  if (!isLoggedIn) return;
  console.log('Attempting to edit case with ID:', caseId, 'Officer ID:', officerId);
  fetch(`${BASE_URL}/cases/${encodeURIComponent(caseId)}`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Fetch failed: ' + response.status);
      return response.json();
    })
    .then(caseToEdit => {
      renderEditForm(caseToEdit, caseId, officerId);
    })
    .catch(error => {
      console.error('Edit case fetch error:', error);
      const caseToEdit = allCases.find(c => c.id === caseId);
      if (caseToEdit) {
        console.log('Using allCases fallback for:', caseId);
        renderEditForm(caseToEdit, caseId, officerId);
      } else {
        alert(`Failed to load case for editing: ${error.message} - Case not found in local data`);
      }
    });
}

function renderEditForm(caseToEdit, caseId, officerId) {
  console.log('Editing case:', caseToEdit);
  editingCaseId = caseId;

  // Populate officer dropdown
  const officerSelect = document.getElementById('edit-officer-select');
  officerSelect.innerHTML = '';
  const officers = Array.isArray(caseToEdit.officers) ? caseToEdit.officers : [];
  officers.forEach(o => {
    const option = document.createElement('option');
    option.value = o.id;
    option.text = `${o.officer || 'Unknown'} (Staff No: ${o.staffNo || 'N/A'})`;
    if (o.id == officerId) option.selected = true; // Select the edited officer
    officerSelect.appendChild(option);
  });

  // Function to populate form fields based on selected officer
  function populateForm(officerData) {
    document.getElementById('edit-id').value = caseToEdit.id;
    document.getElementById('edit-dateOccurrence').value = officerData.dateOccurrence || '';
    document.getElementById('edit-type').value = officerData.type || '';
    document.getElementById('edit-status').value = officerData.status || '';
    console.log('Setting edit-status to:', officerData.status);
    document.getElementById('edit-staffNo').value = officerData.staffNo || '';
    document.getElementById('edit-officer').value = officerData.officer || '';
    document.getElementById('edit-summary').value = officerData.summary || '';
    document.getElementById('edit-investigator').value = officerData.investigator || '';
    document.getElementById('edit-severity').value = officerData.severity || '';
    document.getElementById('edit-section17Date').value = officerData.section17Date || '';
    document.getElementById('edit-policeFriend').value = officerData.policeFriend || '';
    document.getElementById('edit-section18Date').value = officerData.section18Date || '';
    document.getElementById('edit-interviewDate').value = officerData.interviewDate || '';
    document.getElementById('edit-ioReportDate').value = officerData.ioReportDate || '';
    document.getElementById('edit-raAssessment').value = officerData.raAssessment || '';
    document.getElementById('edit-officerAdvisedOfReferral').value = officerData.officerAdvisedOfReferral || '';
    document.getElementById('edit-section24ReplyToRA').value = officerData.section24ReplyToRA || '';
    document.getElementById('edit-misconductMeetingDate').value = officerData.misconductMeetingDate || '';
    document.getElementById('edit-misconductOutcome').value = officerData.misconductOutcome || '';
    document.getElementById('edit-grossMisconductHearingDate').value = officerData.grossMisconductHearingDate || '';
    document.getElementById('edit-hearingOutcome').value = officerData.hearingOutcome || '';
    document.getElementById('edit-appealMade').value = officerData.appealMade || '';
    document.getElementById('edit-appealLetterDate').value = officerData.appealLetterDate || '';
    document.getElementById('edit-appealHearingDate').value = officerData.appealHearingDate || '';
    document.getElementById('edit-appealOutcome').value = officerData.appealOutcome || '';
    document.getElementById('edit-comments').value = officerData.comments || '';

    const breachSelect = document.getElementById('edit-breachOfStandards');
    let breaches = [];
    try {
      breaches = officerData.breachOfStandards ? (Array.isArray(JSON.parse(officerData.breachOfStandards)) ? JSON.parse(officerData.breachOfStandards) : [officerData.breachOfStandards]) : [];
    } catch (e) {
      breaches = officerData.breachOfStandards ? [officerData.breachOfStandards] : [];
    }
    Array.from(breachSelect.options).forEach(option => {
      option.selected = breaches.includes(option.value);
    });
  }

  // Initial population with selected officer
  const initialOfficer = caseToEdit.officers.find(o => o.id == officerId) || caseToEdit.officers[0] || {};
  populateForm(initialOfficer);

  // Add onchange event to update form when officer selection changes
  officerSelect.onchange = () => {
    const selectedOfficerId = officerSelect.value;
    const selectedOfficer = caseToEdit.officers.find(o => o.id == selectedOfficerId) || {};
    populateForm(selectedOfficer);
  };

  // Display current files
  const currentFilesDiv = document.getElementById('edit-current-files');
  currentFilesDiv.innerHTML = caseToEdit.files && caseToEdit.files.length > 0 
    ? caseToEdit.files.map(f => `<p>${f.originalName || 'Unnamed File'} (Uploaded: ${f.uploadDate || 'N/A'}, By: ${f.uploadedBy || 'Unknown'})</p>`).join('')
    : '<p>No files attached</p>';

  openTab({ currentTarget: document.querySelector('.tablink[onclick*="edit-case"]') }, 'edit-case');
  document.getElementById('edit-case').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function saveEditedCase() {
  if (!isLoggedIn || !editingCaseId) return;
  const form = document.getElementById('edit-case-form');
  const formData = new FormData(form);
  const breaches = Array.from(document.getElementById('edit-breachOfStandards').selectedOptions).map(option => option.value);
  formData.set('breachOfStandards', JSON.stringify(breaches));
  const officerId = document.getElementById('edit-officer-select').value;
  if (!officerId) {
    console.error('No officerId selected for case:', editingCaseId);
    alert('Please select an officer to edit.');
    return;
  }
  formData.set('officerId', officerId); // Ensure officerId is set

  // Explicitly set all fields from form inputs to ensure officer-specific data is sent
  formData.set('dateOccurrence', document.getElementById('edit-dateOccurrence').value || '');
  formData.set('type', document.getElementById('edit-type').value || '');
  formData.set('status', document.getElementById('edit-status').value || '');
  formData.set('staffNo', document.getElementById('edit-staffNo').value || '');
  formData.set('officer', document.getElementById('edit-officer').value || '');
  formData.set('summary', document.getElementById('edit-summary').value || '');
  formData.set('investigator', document.getElementById('edit-investigator').value || '');
  formData.set('severity', document.getElementById('edit-severity').value || '');
  formData.set('section17Date', document.getElementById('edit-section17Date').value || '');
  formData.set('policeFriend', document.getElementById('edit-policeFriend').value || '');
  formData.set('section18Date', document.getElementById('edit-section18Date').value || '');
  formData.set('interviewDate', document.getElementById('edit-interviewDate').value || '');
  formData.set('ioReportDate', document.getElementById('edit-ioReportDate').value || '');
  formData.set('raAssessment', document.getElementById('edit-raAssessment').value || '');
  formData.set('officerAdvisedOfReferral', document.getElementById('edit-officerAdvisedOfReferral').value || '');
  formData.set('section24ReplyToRA', document.getElementById('edit-section24ReplyToRA').value || '');
  formData.set('misconductMeetingDate', document.getElementById('edit-misconductMeetingDate').value || '');
  formData.set('misconductOutcome', document.getElementById('edit-misconductOutcome').value || '');
  formData.set('grossMisconductHearingDate', document.getElementById('edit-grossMisconductHearingDate').value || '');
  formData.set('hearingOutcome', document.getElementById('edit-hearingOutcome').value || '');
  formData.set('appealMade', document.getElementById('edit-appealMade').value || '');
  formData.set('appealLetterDate', document.getElementById('edit-appealLetterDate').value || '');
  formData.set('appealHearingDate', document.getElementById('edit-appealHearingDate').value || '');
  formData.set('appealOutcome', document.getElementById('edit-appealOutcome').value || '');
  formData.set('comments', document.getElementById('edit-comments').value || '');

  // Log the full submission
  const data = {};
  formData.forEach((value, key) => data[key] = value);
  console.log('Submitting edit for case:', editingCaseId, 'Officer ID:', officerId, 'Data:', data);

  fetch(`${BASE_URL}/cases/${encodeURIComponent(editingCaseId)}`, {
    method: 'PUT',
    body: formData,
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) return response.json().then(err => { throw new Error(err.error || `Server error: ${response.status}`); });
      return response.json();
    })
    .then(caseData => {
      console.log('Case updated successfully:', caseData);
      editingCaseId = null;
      loadCases(); // Refresh the case list
      clearEditForm();
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="cases"]') }, 'cases');
      alert('Case and officer updated successfully');
    })
    .catch(error => {
      console.error('Save case error:', error);
      alert(`Failed to save case: ${error.message}`);
    });
}


function loadDetailedStats() {
  fetch(`${BASE_URL}/detailed-stats`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Failed to fetch stats: ' + response.status);
      return response.json();
    })
    .then(stats => {
      console.log('Stats received for tables:', stats);
      detailedStats = stats; // Store for exports

      // Cases per Year
      document.getElementById('casesPerYear').querySelector('tbody').innerHTML = stats.casesPerYear.length > 0
        ? stats.casesPerYear.map(row => `<tr><td>${row.year}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="2">No data</td></tr>';

      // Severity Assessment (now per year)
      document.getElementById('severity').querySelector('tbody').innerHTML = stats.severity.length > 0
        ? stats.severity.map(row => `<tr><td>${row.year}</td><td>${row.severity}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Assessment by RA (now per year)
      document.getElementById('raAssessment').querySelector('tbody').innerHTML = stats.raAssessment.length > 0
        ? stats.raAssessment.map(row => `<tr><td>${row.year}</td><td>${row.raAssessment}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Misconduct Outcome (now per year)
      document.getElementById('misconductOutcome').querySelector('tbody').innerHTML = stats.misconductOutcome.length > 0
        ? stats.misconductOutcome.map(row => `<tr><td>${row.year}</td><td>${row.misconductOutcome}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Hearing Outcome (now per year)
      document.getElementById('hearingOutcome').querySelector('tbody').innerHTML = stats.hearingOutcome.length > 0
        ? stats.hearingOutcome.map(row => `<tr><td>${row.year}</td><td>${row.hearingOutcome}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Appeals per Year
      document.getElementById('appealsPerYear').querySelector('tbody').innerHTML = stats.appealsPerYear.length > 0
        ? stats.appealsPerYear.map(row => `<tr><td>${row.year}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="2">No data</td></tr>';

      // Appeal Outcome (now per year)
      document.getElementById('appealOutcome').querySelector('tbody').innerHTML = stats.appealOutcome.length > 0
        ? stats.appealOutcome.map(row => `<tr><td>${row.year}</td><td>${row.appealOutcome}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Case Status (now per year)
      document.getElementById('caseStatus').querySelector('tbody').innerHTML = stats.caseStatus.length > 0
        ? stats.caseStatus.map(row => `<tr><td>${row.year}</td><td>${row.status}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Breaches of Standards (now per year)
      document.getElementById('breachesOfStandards').querySelector('tbody').innerHTML = stats.breachesOfStandards.length > 0
        ? stats.breachesOfStandards.map(row => `<tr><td>${row.year}</td><td>${row.breachOfStandards}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="3">No data</td></tr>';

      // Officer Age at Incident
      document.getElementById('officerAgeAtIncident').querySelector('tbody').innerHTML = stats.officerAgeAtIncident && stats.officerAgeAtIncident.length > 0
        ? stats.officerAgeAtIncident.map(row => `<tr><td>${row.age}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="2">No data</td></tr>';

      // Length of Service at Incident
      document.getElementById('serviceLengthAtIncident').querySelector('tbody').innerHTML = stats.serviceLengthAtIncident && stats.serviceLengthAtIncident.length > 0
        ? stats.serviceLengthAtIncident.map(row => `<tr><td>${row.years}</td><td>${row.count}</td></tr>`).join('')
        : '<tr><td colspan="2">No data</td></tr>';

    })
    .catch(error => {
      console.error('Error loading stats tables:', error);
      const tables = ['casesPerYear', 'severity', 'raAssessment', 'misconductOutcome', 'hearingOutcome', 
                     'appealsPerYear', 'appealOutcome', 'caseStatus', 'breachesOfStandards'];
      tables.forEach(tableId => {
        const tbody = document.getElementById(tableId)?.querySelector('tbody');
        if (tbody) tbody.innerHTML = `<tr><td colspan="${tableId === 'casesPerYear' || tableId === 'appealsPerYear' ? 2 : 3}">Error: ${error.message}</td></tr>`;
      });
    });
}

    function toggleStats(tableId) {
      const table = document.getElementById(tableId);
      table.classList.toggle('active');
    }

// Define chartInstances globally or in a scope accessible to loadCharts

function loadCharts() {
  const chartIds = [
    'casesPerYearBarChart', 'severityBarChart', 'raAssessmentBarChart',
    'misconductOutcomeBarChart', 'hearingOutcomeBarChart', 'appealsPerYearBarChart',
    'appealOutcomeBarChart', 'caseStatusBarChart', 'breachesOfStandardsBarChart',
    'officerAgeBarChart', 'serviceLengthBarChart'
  ];

  // Predefined color palette
  const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF',
    '#FF5733', '#C70039', '#900C3F', '#581845', '#2ECC71', '#3498DB', '#E74C3C',
    '#F1C40F', '#8E44AD', '#16A085', '#D35400', '#7F8C8D'
  ];

  // Destroy all existing charts
  chartIds.forEach(id => {
    if (chartInstances[id]) {
      chartInstances[id].destroy();
      delete chartInstances[id];
    }
  });

  fetch(`${BASE_URL}/detailed-stats`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Failed to fetch stats: ' + response.status);
      return response.json();
    })
    .then(stats => {
      console.log('Stats received for charts:', stats);

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        devicePixelRatio: window.devicePixelRatio || 2,
        scales: { 
          y: { beginAtZero: true, title: { display: true, text: 'Count' } }, 
          x: { title: { display: true, text: 'Year' } } 
        }
      };

      // Cases per Year Bar Chart
      chartInstances['casesPerYearBarChart'] = new Chart(document.getElementById('casesPerYearBarChart'), {
        type: 'bar',
        data: {
          labels: stats.casesPerYear.map(d => d.year),
          datasets: [{
            label: 'Cases',
            data: stats.casesPerYear.map(d => d.count),
            backgroundColor: colors[0] + '99',
            borderColor: colors[0],
            borderWidth: 1
          }]
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Cases per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Severity Bar Chart (grouped by year)
      const severityByYear = stats.severity.reduce((acc, { year, severity, count }) => {
        acc[year] = acc[year] || {};
        acc[year][severity] = count;
        return acc;
      }, {});
      const severityYears = Object.keys(severityByYear).sort();
      const severityTypes = [...new Set(stats.severity.map(d => d.severity))];
      chartInstances['severityBarChart'] = new Chart(document.getElementById('severityBarChart'), {
        type: 'bar',
        data: {
          labels: severityYears,
          datasets: severityTypes.map((type, index) => ({
            label: type,
            data: severityYears.map(year => severityByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Severity Assessment per Year' }, legend: { position: 'bottom' } }
        }
      });

      // RA Assessment Bar Chart (grouped by year)
      const raByYear = stats.raAssessment.reduce((acc, { year, raAssessment, count }) => {
        acc[year] = acc[year] || {};
        acc[year][raAssessment] = count;
        return acc;
      }, {});
      const raYears = Object.keys(raByYear).sort();
      const raTypes = [...new Set(stats.raAssessment.map(d => d.raAssessment))];
      chartInstances['raAssessmentBarChart'] = new Chart(document.getElementById('raAssessmentBarChart'), {
        type: 'bar',
        data: {
          labels: raYears,
          datasets: raTypes.map((type, index) => ({
            label: type,
            data: raYears.map(year => raByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'RA Assessment per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Misconduct Outcome Bar Chart (grouped by year)
      const misconductByYear = stats.misconductOutcome.reduce((acc, { year, misconductOutcome, count }) => {
        acc[year] = acc[year] || {};
        acc[year][misconductOutcome] = count;
        return acc;
      }, {});
      const misconductYears = Object.keys(misconductByYear).sort();
      const misconductTypes = [...new Set(stats.misconductOutcome.map(d => d.misconductOutcome))];
      chartInstances['misconductOutcomeBarChart'] = new Chart(document.getElementById('misconductOutcomeBarChart'), {
        type: 'bar',
        data: {
          labels: misconductYears,
          datasets: misconductTypes.map((type, index) => ({
            label: type,
            data: misconductYears.map(year => misconductByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Misconduct Outcome per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Hearing Outcome Bar Chart (grouped by year)
      const hearingByYear = stats.hearingOutcome.reduce((acc, { year, hearingOutcome, count }) => {
        acc[year] = acc[year] || {};
        acc[year][hearingOutcome] = count;
        return acc;
      }, {});
      const hearingYears = Object.keys(hearingByYear).sort();
      const hearingTypes = [...new Set(stats.hearingOutcome.map(d => d.hearingOutcome))];
      chartInstances['hearingOutcomeBarChart'] = new Chart(document.getElementById('hearingOutcomeBarChart'), {
        type: 'bar',
        data: {
          labels: hearingYears,
          datasets: hearingTypes.map((type, index) => ({
            label: type,
            data: hearingYears.map(year => hearingByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Hearing Outcome per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Appeals per Year Bar Chart
      chartInstances['appealsPerYearBarChart'] = new Chart(document.getElementById('appealsPerYearBarChart'), {
        type: 'bar',
        data: {
          labels: stats.appealsPerYear.map(d => d.year),
          datasets: [{
            label: 'Appeals',
            data: stats.appealsPerYear.map(d => d.count),
            backgroundColor: colors[1] + '99',
            borderColor: colors[1],
            borderWidth: 1
          }]
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Appeals per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Appeal Outcome Bar Chart (grouped by year)
      const appealOutcomeByYear = stats.appealOutcome.reduce((acc, { year, appealOutcome, count }) => {
        acc[year] = acc[year] || {};
        acc[year][appealOutcome] = count;
        return acc;
      }, {});
      const appealOutcomeYears = Object.keys(appealOutcomeByYear).sort();
      const appealOutcomeTypes = [...new Set(stats.appealOutcome.map(d => d.appealOutcome))];
      chartInstances['appealOutcomeBarChart'] = new Chart(document.getElementById('appealOutcomeBarChart'), {
        type: 'bar',
        data: {
          labels: appealOutcomeYears,
          datasets: appealOutcomeTypes.map((type, index) => ({
            label: type,
            data: appealOutcomeYears.map(year => appealOutcomeByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Appeal Outcome per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Case Status Bar Chart (grouped by year)
      const statusByYear = stats.caseStatus.reduce((acc, { year, status, count }) => {
        acc[year] = acc[year] || {};
        acc[year][status] = count;
        return acc;
      }, {});
      const statusYears = Object.keys(statusByYear).sort();
      const statusTypes = [...new Set(stats.caseStatus.map(d => d.status))];
      chartInstances['caseStatusBarChart'] = new Chart(document.getElementById('caseStatusBarChart'), {
        type: 'bar',
        data: {
          labels: statusYears,
          datasets: statusTypes.map((type, index) => ({
            label: type,
            data: statusYears.map(year => statusByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Case Status per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Breaches of Standards Bar Chart (grouped by year)
      const breachesByYear = stats.breachesOfStandards.reduce((acc, { year, breachOfStandards, count }) => {
        acc[year] = acc[year] || {};
        acc[year][breachOfStandards] = count;
        return acc;
      }, {});
      const breachesYears = Object.keys(breachesByYear).sort();
      const breachesTypes = [...new Set(stats.breachesOfStandards.map(d => d.breachOfStandards))];
      chartInstances['breachesOfStandardsBarChart'] = new Chart(document.getElementById('breachesOfStandardsBarChart'), {
        type: 'bar',
        data: {
          labels: breachesYears,
          datasets: breachesTypes.map((type, index) => ({
            label: type,
            data: breachesYears.map(year => breachesByYear[year][type] || 0),
            backgroundColor: colors[index % colors.length] + '99',
            borderColor: colors[index % colors.length],
            borderWidth: 1
          }))
        },
        options: {
          ...commonOptions,
          plugins: { title: { display: true, text: 'Breaches of Standards per Year' }, legend: { position: 'bottom' } }
        }
      });

      // Officer Age at Incident Bar Chart
      chartInstances['officerAgeBarChart'] = new Chart(document.getElementById('officerAgeBarChart'), {
        type: 'bar',
        data: {
          labels: stats.officerAgeAtIncident.map(d => d.age),
          datasets: [{
            label: 'Officers',
            data: stats.officerAgeAtIncident.map(d => d.count),
            backgroundColor: colors[2] + '99',
            borderColor: colors[2],
            borderWidth: 1
          }]
        },
        options: {
          ...commonOptions,
          scales: { 
            y: { beginAtZero: true, title: { display: true, text: 'Count' } }, 
            x: { title: { display: true, text: 'Age' } } 
          },
          plugins: { title: { display: true, text: 'Officer Age at Incident' }, legend: { position: 'bottom' } }
        }
      });

      // Length of Service at Incident Bar Chart
      chartInstances['serviceLengthBarChart'] = new Chart(document.getElementById('serviceLengthBarChart'), {
        type: 'bar',
        data: {
          labels: stats.serviceLengthAtIncident.map(d => d.years),
          datasets: [{
            label: 'Officers',
            data: stats.serviceLengthAtIncident.map(d => d.count),
            backgroundColor: colors[3] + '99',
            borderColor: colors[3],
            borderWidth: 1
          }]
        },
        options: {
          ...commonOptions,
          scales: { 
            y: { beginAtZero: true, title: { display: true, text: 'Count' } }, 
            x: { title: { display: true, text: 'Years of Service' } } 
          },
          plugins: { title: { display: true, text: 'Length of Service at Incident' }, legend: { position: 'bottom' } }
        }
      });
    })
    .catch(error => console.error('Error loading charts:', error));
}

    function createBarChart(canvasId, title, data, key) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
      chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item[key]),
          datasets: [{
            label: title,
            data: data.map(item => item.count),
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false },
            title: { display: true, text: title },
            datalabels: {
              anchor: 'end',
              align: 'top',
              color: '#000',
              font: { weight: 'bold' },
              formatter: (value) => value
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function createBarChart(canvasId, title, data, key) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
      chartInstances[canvasId] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.map(item => item[key]),
          datasets: [{
            data: data.map(item => item.count),
            backgroundColor: [
              'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
              'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)',
              'rgba(199, 199, 199, 0.6)', 'rgba(83, 102, 255, 0.6)', 'rgba(255, 99, 71, 0.6)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
              'rgba(199, 199, 199, 1)', 'rgba(83, 102, 255, 1)', 'rgba(255, 99, 71, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { position: 'right' },
            title: { display: true, text: title },
            datalabels: {
              color: '#fff',
              font: { weight: 'bold' },
              formatter: (value, context) => {
                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                const percentage = ((value / total) * 100).toFixed(1) + '%';
                return `${percentage}\n(${value})`;
              },
              textAlign: 'center'
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    let staffResults = [];

    function searchStaff() {
  if (!isLoggedIn) {
    console.log('Not logged in, skipping searchStaff');
    return;
  }
  const staffNo = document.getElementById('staff-search-input').value.trim();
  if (!staffNo) {
    console.log('Staff number empty, clearing table');
    document.getElementById('staff-case-list').getElementsByTagName('tbody')[0].innerHTML = '';
    staffCases = [];
    return;
  }
  console.log('Searching for staff number:', staffNo);

  // Log staff search action
  fetch(`${BASE_URL}/audit/search-staff`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ staffNo }),
    credentials: 'include'
  }).catch(error => console.error('Audit log error (search staff):', error));

  fetch(`${BASE_URL}/cases-by-officer?staffNo=${encodeURIComponent(staffNo)}`, { credentials: 'include' })
    .then(response => {
      console.log('Staff cases response status:', response.status);
      if (!response.ok) {
        console.log('Fetch failed, status:', response.status);
        throw new Error(`Fetch failed with status: ${response.status}`);
      }
      return response.json();
    })
    .then(cases => {
      console.log('Staff cases received:', cases);
      if (cases) {
        staffCases = cases;
        displayStaffCases(cases);
      } else {
        console.log('No cases returned');
      }
    })
    .catch(error => console.error('Search staff error:', error));
}

function exportStaffCases() {
  console.log('Exporting Staff Cases:', staffCases);
  if (!isLoggedIn) {
    console.error('Cannot export: Not logged in');
    alert('Please log in to export staff cases');
    return;
  }
  if (!staffCases || !Array.isArray(staffCases) || staffCases.length === 0) {
    console.error('No valid data to export for Staff Cases');
    alert('No staff search results available to export. Please perform a search first.');
    return;
  }

  fetch(`${BASE_URL}/audit/extract`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'staff', identifier: 'staff_cases' }),
    credentials: 'include'
  }).catch(error => console.error('Audit log error:', error));

  let csv = 'Case ID,Date of Occurrence,Type,Status,Staff No.,Officer,Summary,Breach of Standards,Investigator,Severity,Section 17 Date,Police Friend,Section 18 Date,Interview Date,IO Report Date,RA Assessment,Officer Advised of Referral,Section 24 Reply to RA,Misconduct Meeting Date,Misconduct Outcome,Gross Misconduct Hearing Date,Hearing Outcome,Appeal Made,Appeal Letter Date,Appeal Hearing Date,Appeal Outcome,Comments,Files\n';
  staffCases.forEach(c => {
    c.officers.forEach(officerData => {
      // Parse and merge breachOfStandards
      let breaches = '';
      try {
        const parsed = officerData.breachOfStandards ? JSON.parse(officerData.breachOfStandards) : [];
        breaches = Array.isArray(parsed) ? parsed.join('; ') : (parsed || officerData.breachOfStandards || '');
      } catch (e) {
        console.error('Error parsing breachOfStandards for export:', e);
        breaches = officerData.breachOfStandards || '';
      }
      // Escape quotes and wrap in quotes to keep it in one column
      breaches = `"${breaches.replace(/"/g, '""')}"`;

      csv += `"${c.caseId || ''}",${formatDate(officerData.dateOccurrence) || ''},${officerData.type || ''},${officerData.status || ''},${officerData.staffNo || ''},${officerData.officer || ''},${officerData.summary || ''},${breaches},${officerData.investigator || ''},${officerData.severity || ''},${formatDate(officerData.section17Date) || ''},${officerData.policeFriend || ''},${formatDate(officerData.section18Date) || ''},${formatDate(officerData.interviewDate) || ''},${formatDate(officerData.ioReportDate) || ''},${officerData.raAssessment || ''},${formatDate(officerData.officerAdvisedOfReferral) || ''},${formatDate(officerData.section24ReplyToRA) || ''},${formatDate(officerData.misconductMeetingDate) || ''},${officerData.misconductOutcome || ''},${formatDate(officerData.grossMisconductHearingDate) || ''},${officerData.hearingOutcome || ''},${officerData.appealMade || ''},${formatDate(officerData.appealLetterDate) || ''},${formatDate(officerData.appealHearingDate) || ''},${officerData.appealOutcome || ''},${officerData.comments || ''},${c.files.length > 0 ? '' : ''}\n`;
    });
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'staff_cases.csv';
  a.click();
  window.URL.revokeObjectURL(url);
}

function displayStaffCases(cases) {
  let tbody = document.getElementById('staff-case-list').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  cases.forEach(c => {
    c.officers.forEach((officerData, index) => {
      console.log('Rendering officer:', officerData.staffNo, {
        officerAdvisedOfReferral: officerData.officerAdvisedOfReferral,
        section24ReplyToRA: officerData.section24ReplyToRA,
        dateOccurrence: officerData.dateOccurrence,
        type: officerData.type,
        status: officerData.status
      });

      let actions = `
        <button class="view-btn" onclick="viewCase('${c.caseId}')">View</button>
      `;
      if (userRole === 'admin' || userRole === 'psd admin' || userRole === 'psd') {
        actions += `<button class="edit-btn" onclick="editCase('${c.caseId}')">Edit</button>`;
      }

      let breaches = '';
      try {
        const parsed = officerData.breachOfStandards ? JSON.parse(officerData.breachOfStandards) : [];
        breaches = Array.isArray(parsed) ? parsed.join(', ') : (parsed || officerData.breachOfStandards || '');
      } catch (e) {
        console.error('Error parsing breachOfStandards:', e);
        breaches = officerData.breachOfStandards || '';
      }
      const filesDisplay = c.files && c.files.length > 0 ? '' : '';

      const section18Days = calculateWorkingDays(officerData.section17Date, officerData.section18Date);
      const section18Style = section18Days !== null ? (section18Days <= 10 ? 'color: green;' : 'color: red;') : '';
      const noticeDays = calculateWorkingDays(officerData.ioReportDate, officerData.officerAdvisedOfReferral);
      const noticeStyle = noticeDays !== null ? (noticeDays <= 15 ? 'color: green;' : 'color: red;') : '';
      const section24Days = calculateWorkingDays(officerData.officerAdvisedOfReferral, officerData.section24ReplyToRA);
      const section24Style = section24Days !== null ? (section24Days <= 14 ? 'color: green;' : 'color: red;') : '';

      const officerCell = (userRole === 'admin' || userRole === 'psd admin')
        ? `<td><a href="#" onclick="viewOfficer('${officerData.staffNo}'); return false;">${officerData.officer || ''}</a></td>`
        : `<td>${officerData.officer || ''}</td>`;

      tbody.innerHTML += `
        <tr>
          <td>${index === 0 ? c.caseId || '' : ''}</td>
          <td>${formatDate(officerData.dateOccurrence || '')}</td>
          <td>${officerData.type || ''}</td>
          <td>${officerData.status || ''}</td>
          <td>${officerData.staffNo || ''}</td>
          ${officerCell}
          <td>${officerData.summary || ''}</td>
          <td>${breaches}</td>
          <td>${officerData.investigator || ''}</td>
          <td>${officerData.severity || ''}</td>
          <td>${formatDate(officerData.section17Date || '')}</td>
          <td>${officerData.policeFriend || ''}</td>
          <td style="${section18Style}">${formatDate(officerData.section18Date || '')}</td>
          <td>${formatDate(officerData.interviewDate || '')}</td>
          <td>${formatDate(officerData.ioReportDate || '')}</td>
          <td>${officerData.raAssessment || ''}</td>
          <td style="${noticeStyle}">${formatDate(officerData.officerAdvisedOfReferral || '')}</td>
          <td style="${section24Style}">${formatDate(officerData.section24ReplyToRA || '')}</td>
          <td>${formatDate(officerData.misconductMeetingDate || '')}</td>
          <td>${officerData.misconductOutcome || ''}</td>
          <td>${formatDate(officerData.grossMisconductHearingDate || '')}</td>
          <td>${officerData.hearingOutcome || ''}</td>
          <td>${officerData.appealMade || ''}</td>
          <td>${formatDate(officerData.appealLetterDate || '')}</td>
          <td>${formatDate(officerData.appealHearingDate || '')}</td>
          <td>${officerData.appealOutcome || ''}</td>
          <td>${officerData.comments || ''}</td>
          <td>${index === 0 ? filesDisplay : ''}</td>
          <td>${actions}</td>
        </tr>`;
    });
  });
}

function exportStatsSection(data, key, filename, customHeader = key.charAt(0).toUpperCase() + key.slice(1)) {
  if (!isLoggedIn || !data || !Array.isArray(data)) {
    console.error('Cannot export: Not logged in or invalid data', { isLoggedIn, data });
    return;
  }

  fetch(`${BASE_URL}/audit/extract`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'case', identifier: filename.split('.')[0] }),
    credentials: 'include'
  }).catch(error => console.error('Audit log error:', error));

  const hasYear = data.some(item => 'year' in item && item.year !== undefined && item[key] !== item.year);
  let csv;

  if (hasYear) {
    csv = `Year,${customHeader},Count\n`;
    data.forEach(item => {
      csv += `${item.year || ''},${item[key] || ''},${item.count || 0}\n`;
    });
  } else {
    csv = `${customHeader},Count\n`;
    data.forEach(item => {
      csv += `${item[key] || ''},${item.count || 0}\n`;
    });
  }

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  window.URL.revokeObjectURL(url);
}

function exportAllStats() {
  console.log('Exporting all stats...');
  fetch(`${BASE_URL}/detailed-stats`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Failed to fetch stats: ' + response.status);
      return response.json();
    })
    .then(stats => {
      console.log('Stats for export:', stats);

      // Flatten the stats object into CSV rows
      const csvRows = [];
      const headers = ['Category', 'Year', 'Key', 'Count'];
      csvRows.push(headers.join(','));

      // Helper function to add rows
      function addRows(category, data, keyName) {
        data.forEach(item => {
          const row = [category, item.year || '', item[keyName] || '', item.count || 0];
          csvRows.push(row.map(val => `"${val}"`).join(','));
        });
      }

      addRows('Cases Per Year', stats.casesPerYear, 'year');
      addRows('Severity', stats.severity, 'severity');
      addRows('RA Assessment', stats.raAssessment, 'raAssessment');
      addRows('Misconduct Outcome', stats.misconductOutcome, 'misconductOutcome');
      addRows('Hearing Outcome', stats.hearingOutcome, 'hearingOutcome');
      addRows('Appeals Per Year', stats.appealsPerYear, 'year');
      addRows('Appeal Outcome', stats.appealOutcome, 'appealOutcome');
      addRows('Case Status', stats.caseStatus, 'status');
      addRows('Breaches of Standards', stats.breachesOfStandards, 'breachOfStandards');
      addRows('Officer Age at Incident', stats.officerAgeAtIncident, 'age');
      addRows('Service Length at Incident', stats.serviceLengthAtIncident, 'years');

      // Create CSV string
      const csvContent = csvRows.join('\n');
      console.log('CSV content prepared:', csvContent.slice(0, 100) + '...');

      // Download as file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `stats_export_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      console.log('Stats exported successfully');
    })
    .catch(error => {
      console.error('Export stats error:', error);
      alert('Failed to export stats: ' + error.message);
    });
}


// Individual export functions remain the same
function exportCasesPerYear() {
  console.log('Exporting Cases per Year:', detailedStats.casesPerYear);
  exportStatsSection(detailedStats.casesPerYear, 'year', 'cases_per_year.csv');
}

function exportSeverity() {
  console.log('Exporting Severity:', detailedStats.severity);
  exportStatsSection(detailedStats.severity, 'severity', 'severity_assessment.csv');
}

function exportRaAssessment() {
  console.log('Exporting RA Assessment:', detailedStats.raAssessment);
  exportStatsSection(detailedStats.raAssessment, 'raAssessment', 'ra_assessment.csv');
}

function exportMisconductOutcome() {
  console.log('Exporting Misconduct Outcome:', detailedStats.misconductOutcome);
  exportStatsSection(detailedStats.misconductOutcome, 'misconductOutcome', 'misconduct_outcome.csv');
}

function exportHearingOutcome() {
  console.log('Exporting Hearing Outcome:', detailedStats.hearingOutcome);
  exportStatsSection(detailedStats.hearingOutcome, 'hearingOutcome', 'hearing_outcome.csv');
}

function exportAppealsPerYear() {
  console.log('Exporting Appeals per Year:', detailedStats.appealsPerYear);
  exportStatsSection(detailedStats.appealsPerYear, 'year', 'appeals_per_year.csv');
}

function exportAppealOutcome() {
  console.log('Exporting Appeal Outcome:', detailedStats.appealOutcome);
  exportStatsSection(detailedStats.appealOutcome, 'appealOutcome', 'appeal_outcome.csv');
}

function exportCaseStatus() {
  console.log('Exporting Case Status:', detailedStats.caseStatus);
  exportStatsSection(detailedStats.caseStatus, 'status', 'case_status.csv');
}

function exportBreachesOfStandards() {
  console.log('Exporting Breaches of Standards:', detailedStats.breachesOfStandards);
  exportStatsSection(detailedStats.breachesOfStandards, 'breachOfStandards', 'breaches_of_standards.csv');
}

function exportOfficerAgeAtIncident() {
  console.log('Exporting Officer Age at Incident:', detailedStats.officerAgeAtIncident);
  if (!detailedStats.officerAgeAtIncident || !Array.isArray(detailedStats.officerAgeAtIncident)) {
    console.error('No valid data to export for Officer Age at Incident');
    alert('No data available to export for Officer Age at Incident');
    return;
  }
  const sortedData = [...detailedStats.officerAgeAtIncident].sort((a, b) => a.age - b.age);
  exportStatsSection(sortedData, 'age', 'officer_age_at_incident.csv', 'Years (Age)');
}

function exportServiceLengthAtIncident() {
  console.log('Exporting Service Length at Incident:', detailedStats.serviceLengthAtIncident);
  if (!detailedStats.serviceLengthAtIncident || !Array.isArray(detailedStats.serviceLengthAtIncident)) {
    console.error('No valid data to export for Service Length at Incident');
    alert('No data available to export for Service Length at Incident');
    return;
  }
  const sortedData = [...detailedStats.serviceLengthAtIncident].sort((a, b) => a.years - b.years);
  exportStatsSection(sortedData, 'years', 'service_length_at_incident.csv', 'Years (Service)');
}

function createUser() {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;
  const username = document.getElementById('new-username').value;
  const email = document.getElementById('new-email').value;
  const name = document.getElementById('new-name').value; // Added name
  const role = document.getElementById('new-role').value;
  if (!username || !email || !name) { // Updated validation
    document.getElementById('user-create-result').innerText = 'Please enter username, email, and name';
    return;
  }
  if (userRole === 'psd admin' && (role === 'psd admin' || role === 'admin')) {
    document.getElementById('user-create-result').innerText = 'PSD Admin cannot create PSD Admin or Admin users';
    return;
  }
  fetch(`${BASE_URL}/admin/users`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, role, email, name }), // Include name
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('User creation failed: ' + response.status);
      return response.json();
    })
    .then(data => {
      document.getElementById('user-create-result').innerText = `User ${data.username} created. One-time password: ${data.oneTimePassword}`;
      loadUsers();
    })
    .catch(error => {
      console.error('Create user error:', error);
      document.getElementById('user-create-result').innerText = 'Failed to create user: ' + error.message;
    });
}

function loadUsers() {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;
  fetch(`${BASE_URL}/admin/users`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Users fetch failed: ' + response.status);
      return response.json();
    })
    .then(users => {
      const tbody = document.getElementById('user-list').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      users.forEach(user => {
        const canModify = userRole === 'admin' || (userRole === 'psd admin' && user.role !== 'admin' && user.role !== 'psd admin');
        tbody.innerHTML += `
          <tr id="user-row-${user.username}">
            <td id="username-display-${user.username}">${user.username}</td>
            <td id="name-display-${user.username}">${user.name || 'N/A'}</td> <!-- Added Name -->
            <td id="email-display-${user.username}">${user.email}</td>
            <td id="role-display-${user.username}">${user.role}</td>
            <td>
              ${canModify ? `
                <button class="edit-btn" onclick="editUser('${user.username}')">Edit</button>
                <button class="delete-btn" onclick="deleteUser('${user.username}')">Delete</button>
                <button class="reset-btn" onclick="resetUserPassword('${user.username}')">Reset Password</button>
              ` : 'View Only'}
            </td>
          </tr>`;
      });
    })
    .catch(error => console.error('Load users error:', error));
}

function editUser(username) {
  const row = document.getElementById(`user-row-${username}`);
  const currentRole = document.getElementById(`role-display-${username}`).textContent;
  const currentName = document.getElementById(`name-display-${username}`).textContent; // Added name
  if (userRole === 'psd admin' && (currentRole === 'admin' || currentRole === 'psd admin')) {
    alert('PSD Admin cannot edit PSD Admin or Admin users');
    return;
  }
  row.innerHTML = `
    <td><input type="text" id="edit-username-${username}" value="${username}"></td>
    <td><input type="text" id="edit-name-${username}" value="${currentName === 'N/A' ? '' : currentName}"></td> <!-- Added Name input -->
    <td><input type="email" id="edit-email-${username}" value="${document.getElementById('email-display-' + username).textContent}"></td>
    <td>
      <select id="edit-role-${username}">
        <option value="admin" ${currentRole === 'admin' ? 'selected' : ''} ${userRole === 'psd admin' ? 'disabled' : ''}>Admin</option>
        <option value="psd admin" ${currentRole === 'psd admin' ? 'selected' : ''} ${userRole === 'psd admin' ? 'disabled' : ''}>PSD Admin</option>
        <option value="psd" ${currentRole === 'psd' ? 'selected' : ''}>PSD</option>
        <option value="auditor" ${currentRole === 'auditor' ? 'selected' : ''}>Auditor</option>
      </select>
    </td>
    <td>
      <button class="save-btn" onclick="saveUser('${username}')">Save</button>
      <button class="delete-btn" onclick="deleteUser('${username}')">Delete</button>
      <button class="reset-btn" onclick="resetUserPassword('${username}')">Reset Password</button>
    </td>
  `;
}

function saveUser(oldUsername) {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;
  const newUsername = document.getElementById(`edit-username-${oldUsername}`).value;
  const email = document.getElementById(`edit-email-${oldUsername}`).value;
  const name = document.getElementById(`edit-name-${oldUsername}`).value; // Added name
  const role = document.getElementById(`edit-role-${oldUsername}`).value;

  if (userRole === 'psd admin' && (role === 'psd admin' || role === 'admin')) {
    alert('PSD Admin cannot set role to PSD Admin or Admin');
    return;
  }

  fetch(`${BASE_URL}/admin/users/${oldUsername}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ newUsername, role, email, name }), // Include name
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('User update failed: ' + response.status);
      return response.json();
    })
    .then(data => {
      console.log(`User ${oldUsername} updated:`, data);
      if (oldUsername === currentUser && oldUsername !== newUsername) {
        currentUser = newUsername;
        document.getElementById('user-info').innerText = `Logged in as: ${newUsername}`;
      }
      loadUsers();
      alert(data.message || 'User updated successfully');
    })
    .catch(error => {
      console.error('Update user error:', error);
      alert(`Failed to update user: ${error.message}`);
    });
}

    function requestPasswordReset() {
  const username = document.getElementById('reset-username').value;
  const email = document.getElementById('reset-email').value;
  if (!username || !email) {
    document.getElementById('login-error').innerText = 'Please enter both username and email';
    return;
  }
  fetch(`${BASE_URL}/request-password-reset`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email })
  })
    .then(response => {
      console.log('Reset request response status:', response.status);
      if (!response.ok) return response.json().then(err => { throw new Error(err.error); });
      return response.json();
    })
    .then(data => {
      console.log('Reset request response:', data);
      document.getElementById('login-error').innerText = 'A temporary password has been sent to your email. Please check your inbox.';
      document.getElementById('reset-request').style.display = 'none';
    })
    .catch(error => {
      console.error('Reset request error:', error);
      document.getElementById('login-error').innerText = 'Failed to request reset: ' + error.message;
    });
}

function resetUserPassword(username) {
  fetch(`${BASE_URL}/admin/reset-password/${encodeURIComponent(username)}`, {
    method: 'POST',
    credentials: 'include'
  })
    .then(response => {
      console.log('Reset request response status:', response.status);
      if (!response.ok) throw new Error('Failed to reset password: ' + response.status);
      return response.json();
    })
    .then(data => {
      console.log('Reset response:', data);
      alert(data.message); // Shows "Password reset email sent to the user"
    })
    .catch(error => {
      console.error('Reset request error:', error);
      alert('Failed to reset password: ' + error.message);
    });
}



function deleteUser(username) {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;
  const role = document.getElementById(`role-display-${username}`).textContent;
  if (userRole === 'psd admin' && (role === 'admin' || role === 'psd admin')) {
    alert('PSD Admin cannot delete PSD Admin or Admin users');
    return;
  }
  if (confirm(`Are you sure you want to delete user ${username}?`)) {
    fetch(`${BASE_URL}/admin/users/${username}`, {
      method: 'DELETE',
      credentials: 'include'
    })
      .then(response => {
        if (!response.ok) throw new Error('Delete failed: ' + response.status);
        return response.json();
      })
      .then(data => {
        console.log(`User ${username} deleted:`, data);
        loadUsers();
        alert(data.message || 'User deleted successfully');
      })
      .catch(error => {
        console.error('Delete user error:', error);
        alert('Failed to delete user: ' + error.message);
      });
  }
}

function loadAuditReport() {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;
  fetch(`${BASE_URL}/audit-logs`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Audit fetch failed: ' + response.status);
      return response.json();
    })
    .then(logs => {
      console.log('Audit logs loaded:', logs); // Debug
      const tbody = document.getElementById('audit-list').getElementsByTagName('tbody')[0];
      tbody.innerHTML = ''; // Clear existing rows
      logs.forEach(log => {
        tbody.innerHTML += `
          <tr>
            <td>${log.id}</td>
            <td>${log.user}</td>
            <td>${log.action}</td>
            <td>${log.details}</td>
            <td>${log.timestamp}</td>
          </tr>`;
      });
    })
    .catch(error => {
      console.error('Load audit error:', error);
      document.getElementById('audit-list').innerHTML = '<p>Error loading audit logs</p>';
    });
}

    function exportAuditReport() {
      if (!isLoggedIn || userRole !== 'admin') return;
      fetch(`${BASE_URL}/audit-logs`, { credentials: 'include' })
        .then(response => response.json())
        .then(logs => {
          let csv = 'ID,User,Action,Details,Timestamp\n';
          logs.forEach(log => {
            csv += `${log.id},${log.user},${log.action},${log.details},${log.timestamp}\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'audit_report.csv';
          a.click();
          window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Export audit error:', error));
    }

    function clearAddForm() {
      document.getElementById('add-case-form').reset();
    }

    function clearEditForm() {
      document.getElementById('edit-case-form').reset();
      editingCaseId = null;
    }

    document.addEventListener('DOMContentLoaded', () => {
  // Sync officerCount for Discipline Disclosure
  const officerList = document.getElementById('disclosure-officer-list');
  if (officerList) {
    officerCount = officerList.getElementsByClassName('officer-entry').length + 1;
    console.log('Initialized officerCount:', officerCount);
  }

  // Existing session check and URL handling
  checkSession(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get('case');
    const officerStaffNo = urlParams.get('officer');
    if (caseId) {
      viewCase(caseId);
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="cases"]') }, 'cases');
    } else if (officerStaffNo && (userRole === 'admin' || userRole === 'psd admin')) {
      viewOfficer(officerStaffNo);
    }
  });
});

function updateAdminTabs() {
  const errorLogTab = document.getElementById('error-log-tab');
  if (userRole === 'admin') {
    errorLogTab.style.display = 'block'; // Show for Admin only
  } else {
    errorLogTab.style.display = 'none'; // Hide for all others, including PSD Admin
  }
}

function loadErrorLogs() {
  if (!isLoggedIn || userRole !== 'admin') return;
  fetch(`${BASE_URL}/error-logs`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error(`Failed to fetch error logs: ${response.status}`);
      return response.json();
    })
    .then(logs => {
      console.log('Error logs loaded:', logs); // Debug
      const tbody = document.getElementById('error-list').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      logs.forEach(log => {
        tbody.innerHTML += `
          <tr>
            <td>${log.id}</td>
            <td>${log.user || 'Unknown'}</td>
            <td>${log.error_description || ''}</td>
            <td>${log.timestamp || ''}</td>
          </tr>`;
      });
    })
    .catch(error => {
      console.error('Load error logs error:', error);
      document.getElementById('error-list').innerHTML = '<p>Error loading error logs</p>';
    });
}

function showErrorModal() {
  document.getElementById('error-modal').style.display = 'block';
  document.getElementById('modal-backdrop').style.display = 'block';
  document.getElementById('error-description').value = '';
}

function hideErrorModal() {
  document.getElementById('error-modal').style.display = 'none';
  document.getElementById('modal-backdrop').style.display = 'none';
}

function submitErrorReport() {
  const errorDescription = document.getElementById('error-description').value.trim();
  if (!errorDescription) {
    alert('Please describe the error');
    return;
  }
  fetch(`${BASE_URL}/report-error`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ errorDescription }),
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error(`Failed to report error: ${response.status}`);
      return response.json();
    })
    .then(data => {
      alert(data.message);
      hideErrorModal();
      if (userRole === 'admin') loadErrorLogs(); // Refresh logs for admin
    })
    .catch(error => {
      console.error('Error reporting error:', error);
      alert('Failed to report error: ' + error.message);
    });
}

Chart.register(ChartDataLabels);

function loadOfficers() {
  console.log('Loading officers for role:', userRole);
  fetch(`${BASE_URL}/officers`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch officers: ${response.status}`);
      }
      return response.json();
    })
    .then(officers => {
      console.log('Officers received:', officers);
      allOfficers = officers;
      displayOfficers(officers);
    })
    .catch(error => {
      console.error('Load officers error:', error);
      const tbody = document.getElementById('officer-list').getElementsByTagName('tbody')[0];
      tbody.innerHTML = `<tr><td colspan="5">Error loading officers: ${error.message}</td></tr>`;
    });
}

function displayOfficers(officers) {
  console.log('Displaying officers:', officers);
  const tbody = document.getElementById('officer-list').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  officers.forEach(officer => {
    let age = '';
    if (officer.dateOfBirth) {
      const dob = new Date(officer.dateOfBirth);
      const today = new Date();
      age = Math.floor((today - dob) / (1000 * 60 * 60 * 24 * 365.25));
    }
    let yearsOfService = '';
    if (officer.joiningDate) {
      const joinDate = new Date(officer.joiningDate);
      const today = new Date();
      yearsOfService = Math.floor((today - joinDate) / (1000 * 60 * 60 * 24 * 365.25));
    }
    tbody.innerHTML += `
      <tr>
        <td style="width: 100px;">${officer.staffNo}</td>
        <td style="width: 150px;">${officer.name}</td>
        <td style="width: 120px;">${formatDate(officer.joiningDate)}</td>
        <td style="width: 100px;">${officer.rank || ''}</td>
        <td style="width: 120px;">${formatDate(officer.dateOfBirth)}</td>
        <td style="width: 60px;">${age || 'N/A'}</td>
        <td style="width: 120px;">${yearsOfService || 'N/A'}</td>
        <td class="frozen" style="display: flex; justify-content: center; gap: 5px;">
          <button class="view-btn" onclick="viewOfficer('${officer.staffNo}')">View</button>
          ${(userRole === 'admin' || userRole === 'psd admin') ? `
            <button class="edit-btn" onclick="editOfficer('${officer.staffNo}')">Edit</button>
            <button class="delete-btn" onclick="deleteOfficerProfile('${officer.staffNo}')">Delete</button>
          ` : ''}
        </td>
      </tr>`;
  });
}

function searchOfficers() {
  const query = document.getElementById('officer-search').value;
  fetch(`${BASE_URL}/search-officers?query=${encodeURIComponent(query)}`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Search failed: ' + response.status);
      return response.json();
    })
    .then(officers => {
      console.log('Filtered officers received:', officers);
      displayOfficers(officers);
    })
    .catch(error => console.error('Error searching officers:', error));
}

function viewCase(caseId, officerId, allOfficers = false) {
  console.log('Viewing case - Case ID:', caseId, 'Officer ID:', officerId, 'All Officers:', allOfficers);
  fetch(`${BASE_URL}/cases/${encodeURIComponent(caseId)}`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Fetch failed: ' + response.status);
      return response.json();
    })
    .then(caseItem => {
      console.log('Case data fetched:', caseItem);
      renderCaseDetailsUpdated(caseItem, caseId, officerId, allOfficers); // Pass allOfficers flag
      document.querySelector('#cases').style.display = 'block';
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="cases"]') }, 'cases');
      const detailsDiv = document.getElementById('case-details');
      const header = detailsDiv.querySelector('h3');
      if (header) {
        header.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    })
    .catch(error => {
      console.error('View case error:', error);
      const caseItem = allCases.find(c => c.id === caseId);
      if (caseItem) {
        renderCaseDetailsUpdated(caseItem, caseId, officerId, allOfficers); // Pass allOfficers flag
        document.querySelector('#cases').style.display = 'block';
        openTab({ currentTarget: document.querySelector('.tablink[onclick*="cases"]') }, 'cases');
        const detailsDiv = document.getElementById('case-details');
        const header = detailsDiv.querySelector('h3');
        if (header) {
          header.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } else {
        document.getElementById('case-details').innerHTML = `<p>Error: ${error.message} - Case not found</p>`;
        document.getElementById('case-details').style.display = 'block';
      }
    });
}


function backToCases() {
  document.getElementById('case-details').style.display = 'none';
  document.getElementById('case-list').style.display = 'table';
  document.getElementById('cases').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function viewOfficer(staffNo) {
  if (userRole !== 'admin' && userRole !== 'psd admin') {
    alert('You are not authorized to view officer profiles.');
    console.log('Unauthorized attempt to view officer profile by:', userRole);
    return;
  }

  console.log('Viewing officer:', staffNo);
  fetch(`${BASE_URL}/officers/${encodeURIComponent(staffNo)}`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      return response.json();
    })
    .then(officer => {
      console.log('Officer data:', officer);
      if (!officer) throw new Error('No officer data received');
      const psdHistory = officer.psdHistory && Array.isArray(officer.psdHistory)
        ? officer.psdHistory.map(caseItem => {
            const caseData = allCases.find(c => c.id === caseItem.caseId) || {};
            const officerData = caseData.officers ? caseData.officers.find(o => o.staffNo === staffNo) : {};
            const officerId = officerData.id || caseItem.officerId || '';
            return `
              <div>
                <a href="#" onclick="viewCase('${caseItem.caseId}', '${officerId}'); setTimeout(() => document.querySelector('#case-details h3').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100); return false;">${caseItem.caseId}</a>
                <span> - Status: ${officerData.status || 'N/A'}</span>
                <p><strong>Summary:</strong> ${officerData.summary || 'N/A'}</p>
                <p><strong>Severity:</strong> ${officerData.severity || 'N/A'}</p>
                <p><strong>Misconduct Outcome:</strong> ${officerData.misconductOutcome || 'N/A'}</p>
                <p><strong>Hearing Outcome:</strong> ${officerData.hearingOutcome || 'N/A'}</p>
                <p><strong>Appeal Outcome:</strong> ${officerData.appealOutcome || 'N/A'}</p>
              </div>`;
          }).join('<br>')
        : 'No PSD history';

      let age = '';
      if (officer.dateOfBirth) {
        const dob = new Date(officer.dateOfBirth);
        const today = new Date();
        age = Math.floor((today - dob) / (1000 * 60 * 60 * 24 * 365.25));
      }
      
      let yearsOfService = '';
      if (officer.joiningDate) {
        const joinDate = new Date(officer.joiningDate);
        const today = new Date();
        yearsOfService = Math.floor((today - joinDate) / (1000 * 60 * 60 * 24 * 365.25));
      }

      const detailsHTML = `
        <h3>Officer Profile: ${officer.name || 'Unknown'}</h3>
        <p><strong>Staff No.:</strong> ${officer.staffNo || ''}</p>
        <p><strong>Name:</strong> ${officer.name || ''}</p>
        <p><strong>Joining Date:</strong> ${officer.joiningDate || ''}</p>
        <p><strong>Years of Service:</strong> ${yearsOfService || 'N/A'}</p>
        <p><strong>Rank:</strong> ${officer.rank || ''}</p>
        <p><strong>Date of Birth:</strong> ${officer.dateOfBirth || ''}</p>
        <p><strong>Age:</strong> ${age || 'N/A'}</p>
        ${officer.photoPath ? `<p><strong>Photo:</strong> <img src="${officer.photoPath}" alt="Officer Photo" style="max-width: 200px;"></p>` : ''}
        <h4>PSD History:</h4>
        <div>${psdHistory}</div>
        <button onclick="backToOfficerProfiles(event)">Back to Officer Profiles</button>
        <button onclick="openTab(event, 'cases')">Return to Cases</button>
      `;
      const detailsDiv = document.getElementById('officer-details');
      detailsDiv.innerHTML = detailsHTML;
      detailsDiv.style.display = 'block';
      // Pass a flag to indicate profile view
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="officer-profiles"]') }, 'officer-profiles', true);
      const header = detailsDiv.querySelector('h3');
      if (header) header.scrollIntoView({ behavior: 'smooth' });
    })
    .catch(error => {
      console.error('View officer error:', error);
      const detailsDiv = document.getElementById('officer-details');
      detailsDiv.innerHTML = `<p>Error loading officer profile: ${error.message}</p><button onclick="openTab(event, 'officer-profiles')">Back to Officer Profiles</button>`;
      detailsDiv.style.display = 'block';
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="officer-profiles"]') }, 'officer-profiles', true);
      const errorHeading = detailsDiv.querySelector('p');
      if (errorHeading) errorHeading.scrollIntoView({ behavior: 'smooth' });
    });
}

function backToOfficerProfiles(evt) {
  document.getElementById('officer-details').style.display = 'none';
  openTab(evt, 'officer-profiles');
}

function editOfficer(staffNo) {
  fetch(`${BASE_URL}/officers/${encodeURIComponent(staffNo)}`, { credentials: 'include' })
    .then(response => response.json())
    .then(officer => {
      document.getElementById('edit-officer-staffNo').value = officer.staffNo || '';
      document.getElementById('edit-officer-name').value = officer.name || '';
      document.getElementById('edit-officer-joiningDate').value = officer.joiningDate || '';
      document.getElementById('edit-officer-rank').value = officer.rank || '';
      document.getElementById('edit-officer-dateOfBirth').value = officer.dateOfBirth || '';
      document.getElementById('edit-officer-modal').style.display = 'block';
      document.getElementById('modal-backdrop').style.display = 'block';
    })
    .catch(error => console.error('Fetch officer error:', error));
}

function closeEditOfficerModal() {
  document.getElementById('edit-officer-modal').style.display = 'none';
  document.getElementById('modal-backdrop').style.display = 'none';
}

function saveOfficer() {
  const staffNo = document.getElementById('edit-officer-staffNo').value;
  const joiningDate = document.getElementById('edit-officer-joiningDate').value;
  const rank = document.getElementById('edit-officer-rank').value;
  const dateOfBirth = document.getElementById('edit-officer-dateOfBirth').value;

  fetch(`${BASE_URL}/officers/${encodeURIComponent(staffNo)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ joiningDate, rank, dateOfBirth }),
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('Failed to update officer');
      return response.json();
    })
    .then(data => {
      closeEditOfficerModal();
      loadOfficers();
      alert(data.message);
      viewOfficer(staffNo); // Refresh profile view
    })
    .catch(error => {
      console.error('Save officer error:', error);
      alert('Failed to save officer: ' + error.message);
    });
}

function deleteOfficer(officerId, caseId) {
  console.log('DEBUG_v3 - Attempting to delete - Case ID:', caseId, 'Officer ID:', officerId);
  if (confirm(`Are you sure you want to delete this officer from case ${caseId}?`)) {
    fetch(`${BASE_URL}/case-officers/${encodeURIComponent(officerId)}`, {
      method: 'DELETE',
      credentials: 'include'
    })
      .then(response => {
        if (!response.ok) throw new Error(`Failed to delete officer: ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('DEBUG_v3 - Delete successful:', data.message);
        loadCases();
        const detailsDiv = document.getElementById('case-details');
        detailsDiv.style.display = 'none';
        detailsDiv.innerHTML = '';
        alert(data.message);
      })
      .catch(error => {
        console.error('Delete officer error:', error);
        alert('Failed to delete officer: ' + error.message);
      });
  }
}


function deleteOfficerProfile(staffNo) {
  console.log('DEBUG_v3 - Attempting to delete officer profile - Staff No.:', staffNo);

  if (!confirm(`Are you sure you want to delete officer profile ${staffNo}? This is only allowed if the officer is not linked to any cases.`)) return;

  fetch(`${BASE_URL}/officers/${encodeURIComponent(staffNo)}`, {
    method: 'DELETE',
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { throw new Error(err.error || `Failed to delete officer: ${response.status}`); });
      }
      return response.json();
    })
    .then(data => {
      console.log('DEBUG_v3 - Profile delete successful:', data.message);
      alert(data.message);
      searchOfficers(); // Refresh Officer Profiles
    })
    .catch(error => {
      console.error('Delete officer profile error:', error);
      alert('Failed to delete officer: ' + error.message);
    });
}

function addOfficer() {
  if (officerCount >= 8) {
    alert('Maximum of 8 officers allowed.');
    return;
  }
  const officerList = document.getElementById('disclosure-officer-list');
  const newEntry = document.createElement('div');
  newEntry.className = 'officer-entry';
  newEntry.innerHTML = `
    <div class="form-group">
      <label for="officer-name-${officerCount}">Officer Name</label>
      <input id="officer-name-${officerCount}" name="officers[${officerCount - 1}][name]" placeholder="Enter Officer Name">
    </div>
    <div class="form-group">
      <label for="staff-id-${officerCount}">Staff ID Number</label>
      <input id="staff-id-${officerCount}" name="officers[${officerCount - 1}][staffId]" placeholder="Enter Staff ID">
    </div>
    <div class="form-group">
      <label for="rank-collar-${officerCount}">Rank & Collar Number</label>
      <input id="rank-collar-${officerCount}" name="officers[${officerCount - 1}][rankCollar]" placeholder="Enter Rank & Collar No.">
    </div>
    <button type="button" class="delete-btn" onclick="removeOfficer(this)" style="${officerCount === 1 ? 'display: none;' : ''}">Remove</button>
  `;
  officerList.appendChild(newEntry);
  officerCount++;
}

function removeOfficer(button) {
  const officerList = document.getElementById('disclosure-officer-list');
  const entry = button.parentElement;
  officerList.removeChild(entry);
  officerCount--;
  if (officerCount === 1) {
    const firstDeleteBtn = officerList.querySelector('.delete-btn');
    if (firstDeleteBtn) firstDeleteBtn.style.display = 'none';
  }
}

function resetDisclosureForm() {
  const form = document.getElementById('disclosure-form');
  form.reset();
  officerCount = 1;
  const officerList = document.getElementById('disclosure-officer-list');
  if (officerList) {
    officerList.innerHTML = '';
    addOfficer(); // Add initial officer entry
  }
  document.getElementById('disclosure-result').innerText = '';
}

function generateDisclosureReport() {
  const form = document.getElementById('disclosure-form');
  const formData = new FormData(form);
  const data = {
    rciNo: formData.get('rciNo') || '',
    rgpNo: formData.get('rgpNo') || '',
    rtoNo: formData.get('rtoNo') || '',
    obNo: formData.get('obNo') || '',
    caseName: formData.get('caseName') || '',
    oicName: formData.get('oicName') || '',
    section: formData.get('section') || '',
    officers: []
  };

  for (let i = 0; i < officerCount; i++) {
    const name = formData.get(`officers[${i}][name]`) || '';
    const staffId = formData.get(`officers[${i}][staffId]`) || '';
    const rankCollar = formData.get(`officers[${i}][rankCollar]`) || '';
    
    if (name || staffId || rankCollar) {
      data.officers.push({
        name: name,
        staffId: staffId,
        rankCollar: rankCollar
      });
    }
  }

  if (data.officers.length === 0) {
    alert('Please add at least one officer to generate the report.');
    return;
  }

  fetch(`${BASE_URL}/generate-disclosure-report`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('Failed to generate report');
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Discipline_Disclosure_${data.caseName.replace(/\s+/g, '_') || 'Report'}.docx`;
      a.click();
      window.URL.revokeObjectURL(url);
      document.getElementById('disclosure-result').innerText = 'Report generated successfully!';
      form.reset(); // Reset form
      officerCount = 0; // Reset officer count
      const officerContainer = document.getElementById('officer-container'); // Adjust ID if needed
      if (officerContainer) officerContainer.innerHTML = ''; 
    })
    .catch(error => {
      console.error('Error generating report:', error);
      document.getElementById('disclosure-result').innerText = 'Error: ' + error.message;
    });
}

document.addEventListener('DOMContentLoaded', () => {
  checkSession(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get('case');
    const officerStaffNo = urlParams.get('officer');
    if (caseId) {
      viewCase(caseId);
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="cases"]') }, 'cases');
    } else if (officerStaffNo && (userRole === 'admin' || userRole === 'psd admin')) {
      viewOfficer(officerStaffNo);
    }
    // Add initial officer entry on load
    addOfficer();
  });
});

document.addEventListener('DOMContentLoaded', () => {
  console.log('Checking DOM: disclosure exists?', !!document.getElementById('disclosure-area'));
  checkSession(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get('case');
    const officerStaffNo = urlParams.get('officer');
    if (caseId) {
      viewCase(caseId);
      openTab({ currentTarget: document.querySelector('.tablink[onclick*="cases"]') }, 'cases');
    } else if (officerStaffNo && (userRole === 'admin' || userRole === 'psd admin')) {
      viewOfficer(officerStaffNo);
    }
    addOfficer(); // Add initial officer entry
  });
});

function resetEditMisconductOutcome() {
    document.getElementById("edit-misconductOutcome").value = "";
  }

  function resetEditHearingOutcome() {
    document.getElementById("edit-hearingOutcome").value = "";
  }

 
// Handle form submission
document.getElementById('permission-form').addEventListener('submit', async (e) => {
  console.log('Form submit event triggered');
  e.preventDefault();
  console.log('Default prevented');

  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) {
    console.log('Blocked: Insufficient privileges', { isLoggedIn, userRole });
    alert('Unauthorized access');
    return;
  }

  // Collect values from the form
  const username = document.getElementById('perm-username').value;
  const caseId = document.getElementById('perm-caseId').value;
  const canView = document.getElementById('perm-canView').checked;
  const canEdit = document.getElementById('perm-canEdit').checked;

  const formData = {
    username: username,
    caseId: caseId,
    canView: canView,
    canEdit: canEdit
  };

  if (!username || !caseId) {
    alert('Please select a username and case ID.');
    return;
  }

  console.log('Sending permissions:', formData);

  try {
    const response = await fetch(`${BASE_URL}/admin/permissions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData),
      credentials: 'include'
    });
    console.log('Fetch response status:', response.status);
    const text = await response.text();
    console.log('Raw response:', text);
    if (!response.ok) {
      const errorData = JSON.parse(text);
      throw new Error(errorData.error || text);
    }
    const data = JSON.parse(text);
    console.log('Success response:', data);
    alert('Permission assigned/updated successfully!');

    // Refresh the permissions table immediately
    await loadPermissions(); // Ensure this completes before proceeding
    ensurePermissionsTabActive(); // Keep the tab visible

  } catch (error) {
    console.error('Assign permission error:', error);
    alert('Failed to assign/update permission: ' + error.message);
  }
  console.log('Form submission completed');
});

// Ensure the permissions tab is active and visible
function ensurePermissionsTabActive() {
  const permissionsTab = document.getElementById('user-permissions');
  const tabButton = document.querySelector('.tablink[onclick*="user-permissions"]');
  
  // Show the tab content
  const tabContents = document.getElementsByClassName('admin-tabcontent');
  for (let i = 0; i < tabContents.length; i++) {
    tabContents[i].style.display = 'none';
  }
  permissionsTab.style.display = 'block';

  // Highlight the tab button
  const tabLinks = document.querySelectorAll('#admin-area .tabs button');
  for (let i = 0; i < tabLinks.length; i++) {
    tabLinks[i].classList.remove('active');
  }
  tabButton.classList.add('active');

  // Optional: Scroll to the table for visibility
  document.querySelector('#permissions-table').scrollIntoView({ behavior: 'smooth' });
}

// Remove permission
function removePermission(id) {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;
  if (!confirm('Are you sure you want to remove this permission?')) return;

  fetch(`${BASE_URL}/admin/permissions/${id}`, {
    method: 'DELETE',
    credentials: 'include'
  })
    .then(response => {
      if (!response.ok) throw new Error('Delete failed');
      return response.json();
    })
    .then(data => {
      alert(data.message || 'Permission removed successfully!');
      loadPermissions(); // Refresh table
    })
    .catch(error => {
      console.error('Remove permission error:', error);
      alert('Failed to remove permission: ' + error.message);
    });
}

function loadPermissions() {
  if (!isLoggedIn || (userRole !== 'admin' && userRole !== 'psd admin')) return;

  // Fetch PSD users
  fetch(`${BASE_URL}/admin/users`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Users fetch failed');
      return response.json();
    })
    .then(users => {
      const psdUsers = users.filter(user => user.role === 'psd');
      const userSelect = document.getElementById('perm-username');
      userSelect.innerHTML = '<option value="">Select User</option>' +
        psdUsers.map(user => `<option value="${user.username}">${user.username}</option>`).join('');
    })
    .catch(error => console.error('Load PSD users error:', error));

  // Fetch cases
  fetch(`${BASE_URL}/cases`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Cases fetch failed');
      return response.json();
    })
    .then(cases => {
      const caseSelect = document.getElementById('perm-caseId');
      caseSelect.innerHTML = '<option value="">Select Case</option>' +
        cases.map(caseItem => `<option value="${caseItem.id}">${caseItem.id}</option>`).join('');
    })
    .catch(error => console.error('Load cases error:', error));

  // Fetch current permissions
  fetch(`${BASE_URL}/admin/permissions`, { credentials: 'include' })
    .then(response => {
      if (!response.ok) throw new Error('Permissions fetch failed');
      return response.json();
    })
    .then(permissions => {
      console.log('Permissions from /admin/permissions:', permissions);
      const tbody = document.querySelector('#permissions-table tbody');
      tbody.innerHTML = permissions.map(perm => `
        <tr>
          <td>${perm.id}</td>
          <td>${perm.username}</td>
          <td>${perm.caseId}</td>
          <td>${perm.canView ? 'Yes' : 'No'}</td>
          <td>${perm.canEdit ? 'Yes' : 'No'}</td>
          <td>${perm.assignedBy}</td>
          <td>${formatDate(perm.assignedDate)}</td>
          <td class="frozen">
            <button class="delete-btn" onclick="removePermission(${perm.id})">Remove</button>
          </td>
        </tr>
      `).join('');
    })
    .catch(error => console.error('Load permissions error:', error));
}

// Update openAdminTab to load permissions
function openAdminTab(evt, tabName) {
  const tabcontent = document.getElementsByClassName('admin-tabcontent');
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = 'none';
  }
  const tablinks = document.querySelectorAll('#admin-area .tabs button');
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].classList.remove('active');
  }
  document.getElementById(tabName).style.display = 'block';
  evt.currentTarget.classList.add('active');

  if (tabName === 'error-log') loadErrorLogs();
  if (tabName === 'audit-report') loadAuditReport();
  if (tabName === 'user-management') loadUsers();
  if (tabName === 'user-permissions') loadPermissions(); // Add this line
}

  
</script>
<div id="error-modal" class="error-modal">
  <h3>Report an Error</h3>
  <textarea id="error-description" placeholder="Describe the error..."></textarea>
  <button onclick="submitErrorReport()">Submit</button>
  <button onclick="hideErrorModal()" style="background-color: #757575;">Cancel</button>
</div>
<button class="error-report-btn" onclick="showErrorModal()">Report Error</button>
</body>
<footer>
  <p id="copyright" style="text-align: center;"> <span id="year"></span> Nathan Victory. All rights reserved.</p>
</footer>
</html>